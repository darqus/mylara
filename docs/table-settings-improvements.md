# Улучшения системы настроек таблиц

## Проблемы, которые были решены

### 1. Проблема с переключением между коллекциями

**Проблема**: При переключении между разными коллекциями настройки таблицы не загружались из localStorage для новой коллекции.

**Решение**:

- Добавлена функция `loadTableSettingsForCollection()` в `AdminCollectionPage.vue`
- Добавлена функция `reloadSettings()` в `useTableSettings.ts` для принудительной перезагрузки настроек
- Обновлен watcher для коллекций, чтобы загружать настройки при переключении

### 2. Слабая валидация данных из localStorage

**Проблема**: Данные из localStorage загружались без должной валидации, что могло привести к ошибкам при некорректных данных.

**Решение**:

- Улучшена функция `loadSettings()` с строгой валидацией каждого поля
- Улучшена функция `loadColumnSettings()` с валидацией настроек колонок
- Добавлена валидация в `importAllSettings()`

### 3. Отсутствие механизма принудительной перезагрузки

**Проблема**: Не было способа принудительно перезагрузить настройки из localStorage после их изменения.

**Решение**:

- Добавлена функция `reloadSettings()` для настроек таблиц
- Добавлена функция `reloadColumnSettings()` для настроек колонок

## Новые функции

### useTableSettings()

```typescript
// Новые функции
reloadSettings(): void // Принудительная перезагрузка настроек из localStorage
```

### useColumnSettings()

```typescript
// Новые функции
reloadColumnSettings(): void // Принудительная перезагрузка настроек колонок
```

## Улучшенная валидация

### Настройки таблицы

- `page`: проверяется, что это число больше 0
- `rowsPerPage`: проверяется, что это число больше 0
- `sortBy`: проверяется, что это непустая строка
- `descending`: проверяется, что это boolean
- `filter`: проверяется, что это строка
- `visibleColumns`: проверяется, что это массив

### Настройки колонок

- `width`: проверяется, что это число больше 0
- `visible`: проверяется, что это boolean

## Как это решает проблемы с обновлением страницы и переключением таблиц

### Обновление страницы

1. При создании composable `useTableSettings(collectionName)` автоматически загружаются настройки из localStorage
2. Благодаря улучшенной валидации некорректные данные отфильтровываются
3. Настройки применяются к таблице через реактивные свойства Vue

### Переключение между коллекциями

1. Watcher отслеживает изменения `collectionName`
2. При изменении вызывается `loadTableSettingsForCollection()`
3. Эта функция использует `reloadSettings()` для принудительной перезагрузки
4. Настройки обновляются в состоянии таблицы

## Тестирование

Добавлены comprehensive тесты в `useTableSettings.vitest.spec.ts`, которые покрывают:

- Загрузку настроек по умолчанию
- Валидацию корректных данных
- Фильтрацию некорректных данных
- Обработку ошибок localStorage
- Валидацию настроек колонок
- Функциональность менеджера настроек

## Производительность

- Валидация выполняется только при загрузке данных
- Используется глубокое наблюдение только для автосохранения
- Принудительная перезагрузка вызывается только при необходимости

## Совместимость

Все изменения обратно совместимы. Существующие данные в localStorage будут корректно загружены и валидированы.
