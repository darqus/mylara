import{d as O,r as b,c as z,w as A,D as $,f as y,s as v,E as q,q as o,e as V,t as Y,x as S,K as k,ah as R,p as c,J as Q,ac as Z,L as I,a2 as se,X as ie,W as ae,T as N,a3 as ue,S as de,H as me,U as le,P as M,a4 as E,ai as ce,R as ve,a6 as ge,a as pe,aj as fe,ak as te,al as ye,a0 as he}from"./vendor-4cnWJq__.js";import{r as oe,u as be,j as _e,k as we,b as xe}from"./firebase-vendor-DF-ErlKL.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{a as ke}from"./admin-config.service-PhUJWde6.js";import{f as K}from"./firestore.service-DVoyk11_.js";import"./index-CK2exzeq.js";let ee;try{ee=xe()}catch(U){console.error("Error initializing Firebase Storage:",U)}class $e{storage;constructor(){if(!ee)throw new Error("Firebase Storage not initialized");this.storage=ee}async uploadImage(s,r={}){try{const m=this.validateImageFile(s,r);if(m)return{error:m};const u=r.filename??this.generateFileName(s),p=`${r.path??"images"}/${u}`,f=oe(this.storage,p),h=await be(f,s);return{url:await _e(h.ref)}}catch(m){return console.error("Error uploading image:",m),{error:"Ошибка при загрузке изображения"}}}async uploadImageWithProgress(s,r={},m){try{const u=this.validateImageFile(s,r);if(u)return{error:u};const e=await this.uploadImage(s,r);return m&&e.url&&m({percentage:100,bytesTransferred:s.size,totalBytes:s.size}),e}catch(u){return console.error("Error uploading image with progress:",u),{error:"Ошибка при загрузке изображения"}}}async deleteImageByUrl(s){try{const r=this.extractPathFromUrl(s);if(!r)return{error:"Невозможно определить путь к файлу"};const m=oe(this.storage,r);return await we(m),{}}catch(r){return console.error("Error deleting image:",r),{error:"Ошибка при удалении изображения"}}}validateImageFile(s,r){const m=r.allowedTypes??["image/jpeg","image/jpg","image/png","image/gif","image/webp"];if(!m.includes(s.type))return`Неподдерживаемый тип файла. Разрешены: ${m.map(p=>p.split("/")[1]).join(", ")}`;const u=r.maxSizeKB??5e3;return s.size/1024>u?`Размер файла слишком большой. Максимум: ${u}KB`:null}generateFileName(s){const r=s.name.split(".").pop()??"jpg",m=Date.now(),u=Math.random().toString(36).substring(2,10);return`${m}_${u}.${r}`}extractPathFromUrl(s){try{const u=new URL(s).pathname.match(/\/o\/(.+)/);return u&&u[1]?decodeURIComponent(u[1]):null}catch{return null}}}const re=new $e,Ve={class:"image-uploader"},Se=["disabled"],Ue={key:0,class:"image-preview"},Ce={class:"image-info"},Ie={class:"text-caption text-grey-7"},qe={class:"text-caption text-grey-6"},De={key:1,class:"upload-placeholder"},ze={class:"text-caption text-grey-5"},Be={key:2,class:"upload-overlay"},Fe={class:"text-body2 text-grey-8"},Pe={key:0,class:"text-negative q-mt-sm"},Te=O({name:"ImageUploader",__name:"ImageUploader",props:{modelValue:{default:null},disabled:{type:Boolean,default:!1},maxSizeKB:{default:5e3},allowedTypes:{default:()=>["image/jpeg","image/jpg","image/png","image/gif","image/webp"]},path:{default:"images"},placeholder:{default:""}},emits:["update:modelValue","upload-start","upload-success","upload-error"],setup(U,{emit:s}){const r=U,m=s,u=b(),e=b(!1),p=b(!1),f=b(0),h=b(""),_=b(null),x=b(""),n=b(0),g=z({get:()=>r.modelValue,set:d=>m("update:modelValue",d)});A(()=>r.modelValue,d=>{d&&d!==_.value?(_.value=d,x.value=P(d),n.value=0):d||F()},{immediate:!0});function a(){!r.disabled&&u.value&&u.value.click()}function w(d){const l=d.target.files?.[0];l&&j(l)}function W(){r.disabled||(e.value=!0)}function B(){r.disabled||(e.value=!0)}function G(){e.value=!1}function C(d){if(e.value=!1,r.disabled)return;const t=d.dataTransfer?.files[0];t&&t.type.startsWith("image/")&&j(t)}async function j(d){h.value="",p.value=!0,f.value=0,J(d),m("upload-start");const t={path:r.path,maxSizeKB:r.maxSizeKB,allowedTypes:r.allowedTypes};try{const l=await re.uploadImageWithProgress(d,t,i=>{f.value=i.percentage});l.error?(h.value=l.error,m("upload-error",l.error),F()):l.url&&(g.value=l.url,m("upload-success",l.url))}finally{p.value=!1,f.value=0}}function J(d){const t=new FileReader;t.onload=l=>{_.value=l.target?.result,x.value=d.name,n.value=d.size},t.readAsDataURL(d)}function F(){_.value=null,x.value="",n.value=0}async function H(){if(g.value){try{await re.deleteImageByUrl(g.value)}catch(d){console.warn("Error deleting image:",d)}g.value=null,F(),h.value=""}}function L(d){if(d===0)return"0 Bytes";const t=1024,l=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(d)/Math.log(t));return`${parseFloat((d/Math.pow(t,i)).toFixed(2))} ${l[i]}`}function P(d){try{const i=new URL(d).pathname.split("/");return i[i.length-1]??"image"}catch{return"image"}}return(d,t)=>(y(),$("div",Ve,[v("div",{class:ie([{"upload-area--dragover":e.value,"upload-area--disabled":d.disabled},"upload-area"]),onClick:a,onDragenter:R(W,["prevent"]),onDragleave:R(G,["prevent"]),onDragover:R(B,["prevent"]),onDrop:R(C,["prevent"])},[v("input",{ref_key:"fileInput",ref:u,disabled:d.disabled,accept:"image/*",style:{display:"none"},type:"file",onChange:w},null,40,Se),_.value?(y(),$("div",Ue,[o(Y,{alt:x.value,src:_.value,class:"rounded-borders",style:{"max-width":"100%","max-height":"200px"}},null,8,["alt","src"]),v("div",Ce,[v("div",Ie,S(x.value),1),v("div",qe,S(L(n.value)),1)]),d.disabled?q("",!0):(y(),V(k,{key:0,class:"image-remove-btn",color:"negative",icon:"close",size:"sm",dense:"",round:"",onClick:R(H,["stop"])},{default:c(()=>[o(Z,null,{default:c(()=>t[0]||(t[0]=[Q("Удалить изображение")])),_:1,__:[0]})]),_:1}))])):(y(),$("div",De,[o(I,{color:"grey-5",name:"cloud_upload",size:"48px"}),t[1]||(t[1]=v("div",{class:"text-h6 text-grey-7 q-mt-sm"}," Загрузить изображение ",-1)),t[2]||(t[2]=v("div",{class:"text-caption text-grey-6"}," Перетащите файл сюда или нажмите для выбора ",-1)),t[3]||(t[3]=v("div",{class:"text-caption text-grey-5 q-mt-sm"}," Поддерживаемые форматы: JPG, PNG, GIF, WebP ",-1)),v("div",ze," Максимальный размер: "+S(L((d.maxSizeKB??5e3)*1024)),1)])),p.value?(y(),$("div",Be,[o(se,{thickness:.2,value:f.value,class:"q-ma-md",color:"primary",size:"50px","track-color":"grey-3"},null,8,["value"]),v("div",Fe," Загрузка... "+S(f.value)+"% ",1)])):q("",!0)],34),h.value?(y(),$("div",Pe,[o(I,{class:"q-mr-xs",name:"error"}),Q(" "+S(h.value),1)])):q("",!0)]))}}),Re=ne(Te,[["__scopeId","data-v-c2e166eb"]]),Ee={class:"text-h6"},Qe={class:"row"},Ne={key:5,class:"q-mb-md"},je={class:"text-subtitle2 q-mb-sm"},Le={key:0,class:"text-negative"},Ke=O({name:"AdminFormDialog",__name:"AdminFormDialog",props:{modelValue:{type:Boolean},config:{},item:{},loading:{type:Boolean}},emits:["update:modelValue","save","cancel"],setup(U,{emit:s}){const r=U,m=s,u=b(),e=b({}),p=z(()=>!!r.item?.id);A(()=>r.item,n=>{n?e.value={...n}:f()},{immediate:!0}),A(()=>r.modelValue,n=>{n||f()});function f(){e.value={},r.config?.fields&&r.config.fields.forEach(n=>{switch(n.type){case"boolean":e.value[n.name]=!1;break;case"number":e.value[n.name]=0;break;default:e.value[n.name]=""}})}function h(n){const g=[];return n.required&&g.push(a=>n.type==="boolean"?!0:a!=null&&String(a).trim()!==""||"Поле обязательно для заполнения"),n.type==="email"&&g.push(a=>a?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(a))||"Введите корректный email":!0),n.type==="url"&&g.push(a=>{if(!a)return!0;try{return new URL(String(a)),!0}catch{return"Введите корректный URL"}}),n.rules&&g.push(...n.rules),g}function _(n){return n==="email"?"email":n==="url"?"url":"text"}async function x(){if(!u.value||!await u.value.validate())return;const g={...e.value};p.value||(delete g.id,delete g.createdAt,delete g.updatedAt),m("save",g)}return(n,g)=>(y(),V(ae,{"model-value":n.modelValue,"onUpdate:modelValue":g[1]||(g[1]=a=>n.$emit("update:modelValue",a))},{default:c(()=>[o(M,{style:{"min-width":"500px","max-width":"800px"}},{default:c(()=>[o(N,null,{default:c(()=>[v("div",Ee,S(p.value?"Редактировать запись":"Создать запись"),1)]),_:1}),o(N,{class:"q-pt-none"},{default:c(()=>[o(ue,{ref_key:"formRef",ref:u,onSubmit:x},{default:c(()=>[v("div",Qe,[(y(!0),$(me,null,de(n.config?.fields||[],a=>(y(),$("div",{key:a.name,class:"col-12"},[["text","email","url"].includes(a.type)?(y(),V(E,{key:0,label:a.label,"model-value":String(e.value[a.name]||""),placeholder:a.placeholder,required:a.required,rules:h(a),type:_(a.type),filled:"","onUpdate:modelValue":w=>e.value[a.name]=w},null,8,["label","model-value","placeholder","required","rules","type","onUpdate:modelValue"])):a.type==="number"?(y(),V(E,{key:1,label:a.label,"model-value":Number(e.value[a.name]||0),placeholder:a.placeholder,required:a.required,rules:h(a),type:"number",filled:"","onUpdate:modelValue":w=>e.value[a.name]=Number(w)},null,8,["label","model-value","placeholder","required","rules","onUpdate:modelValue"])):a.type==="textarea"?(y(),V(E,{key:2,label:a.label,"model-value":String(e.value[a.name]||""),placeholder:a.placeholder,required:a.required,rules:h(a),rows:"4",type:"textarea",filled:"","onUpdate:modelValue":w=>e.value[a.name]=w},null,8,["label","model-value","placeholder","required","rules","onUpdate:modelValue"])):a.type==="date"?(y(),V(E,{key:3,label:a.label,"model-value":String(e.value[a.name]||""),required:a.required,rules:h(a),type:"date",filled:"","onUpdate:modelValue":w=>e.value[a.name]=w},null,8,["label","model-value","required","rules","onUpdate:modelValue"])):a.type==="boolean"?(y(),V(ce,{key:4,label:a.label,"model-value":!!e.value[a.name],"onUpdate:modelValue":w=>e.value[a.name]=w},null,8,["label","model-value","onUpdate:modelValue"])):a.type==="image"?(y(),$("div",Ne,[v("div",je,[Q(S(a.label)+" ",1),a.required?(y(),$("span",Le,"*")):q("",!0)]),o(Re,{"model-value":e.value[a.name]?String(e.value[a.name]):null,"onUpdate:modelValue":w=>e.value[a.name]=w},null,8,["model-value","onUpdate:modelValue"])])):q("",!0)]))),128))])]),_:1},512)]),_:1}),o(le,{align:"right",class:"text-primary"},{default:c(()=>[o(k,{color:"grey-6",label:"Отмена",outline:"",onClick:g[0]||(g[0]=a=>n.$emit("cancel"))}),o(k,{loading:n.loading,color:"positive",label:"Сохранить",outline:"",onClick:x},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Ae={class:"image-cell"},Me={class:"image-overlay"},Oe={class:"image-error"},We={key:1,class:"image-placeholder"},Ge={class:"image-error-full"},Je=O({name:"ImageTableCell",__name:"ImageTableCell",props:{imageUrl:{default:null},alt:{default:"Image"},size:{default:40}},setup(U){const s=U,r=b(!1);function m(){s.imageUrl&&(r.value=!0)}function u(){if(!s.imageUrl)return;const e=document.createElement("a");e.href=s.imageUrl,e.download=s.alt||"image",e.target="_blank",document.body.appendChild(e),e.click(),document.body.removeChild(e)}return(e,p)=>(y(),$("div",Ae,[e.imageUrl?(y(),V(Y,{key:0,alt:e.alt,src:e.imageUrl,class:"image-thumbnail",fit:"cover",loading:"lazy",onClick:m},{error:c(()=>[v("div",Oe,[o(I,{color:"grey-5",name:"broken_image",size:"24px"})])]),default:c(()=>[v("div",Me,[o(I,{color:"white",name:"zoom_in",size:"20px"})])]),_:1},8,["alt","src"])):(y(),$("div",We,[o(I,{color:"grey-5",name:"image",size:"24px"})])),o(ae,{modelValue:r.value,"onUpdate:modelValue":p[1]||(p[1]=f=>r.value=f)},{default:c(()=>[o(M,{class:"image-dialog"},{default:c(()=>[o(N,{class:"q-pa-none"},{default:c(()=>[o(Y,{alt:e.alt,src:e.imageUrl||void 0,fit:"contain",style:{"max-height":"80vh","max-width":"80vw"}},{error:c(()=>[v("div",Ge,[o(I,{color:"grey-5",name:"broken_image",size:"48px"}),p[2]||(p[2]=v("div",{class:"text-grey-7 q-mt-sm"}," Ошибка загрузки изображения ",-1))])]),_:1},8,["alt","src"])]),_:1}),o(le,{align:"right"},{default:c(()=>[o(k,{label:"Закрыть",flat:"",onClick:p[0]||(p[0]=f=>r.value=!1)}),e.imageUrl?(y(),V(k,{key:0,color:"primary",icon:"download",label:"Скачать",flat:"",onClick:u})):q("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}}),He=ne(Je,[["__scopeId","data-v-578347f2"]]),Xe={class:"row items-center justify-between q-mb-md"},Ye={class:"text-h4"},Ze={class:"row q-gutter-md items-center"},ea={class:"col-12 col-md-6"},aa={class:"col-auto"},la={key:0,class:"col-auto"},ta={class:"col-auto text-grey-6"},oa={class:"full-width row flex-center text-grey-7 q-gutter-sm"},ra={class:"q-ml-sm"},ga=O({name:"AdminCollectionPage",__name:"AdminCollectionPage",setup(U){const s=ve(),r=ge(),m=z(()=>r.params.collection),u=z(()=>ke(m.value)),e=b({items:[],loading:!1,pagination:{page:1,rowsPerPage:10,rowsNumber:0},filter:"",selected:[]}),p=b([]),f=b([]),h=b(!1),_=b(!1),x=b(!1),n=b(null),g=b(null),a=z(()=>e.value.filter.trim()?`Найдено: ${f.value.length} из ${p.value.length}`:`Всего записей: ${p.value.length}`),w=z(()=>e.value.selected.length>1?`Вы действительно хотите удалить ${e.value.selected.length} записей?`:"Вы действительно хотите удалить эту запись?");pe(()=>{C()}),A(()=>m.value,(t,l)=>{t!==l&&t&&(W(),l&&u.value?.label&&s.notify({type:"info",message:`Переключено на: ${u.value.label}`,position:"top",timeout:1e3}),C())});function W(){e.value={items:[],loading:!0,pagination:{page:1,rowsPerPage:10,rowsNumber:0},filter:"",selected:[]},p.value=[],f.value=[],h.value=!1,_.value=!1,n.value=null,g.value=null}function B(t){if(!t.trim()){f.value=[...p.value],e.value.items=f.value,e.value.pagination.rowsNumber=f.value.length;return}const l=t.toLowerCase(),i=u.value?.fields?.map(D=>D.name)??[];f.value=p.value.filter(D=>i.some(T=>{const X=D[T];return X==null?!1:String(X).toLowerCase().includes(l)})),e.value.items=f.value,e.value.pagination.rowsNumber=f.value.length,e.value.pagination.page=1}function G(){e.value.filter="",B("")}async function C(){if(!u.value){s.notify({type:"negative",message:"Конфигурация коллекции не найдена",position:"top"});return}e.value.loading=!0;try{const t=await K.getCollection(m.value);t.error?s.notify({type:"negative",message:t.error,position:"top"}):(p.value=t.items,B(e.value.filter))}finally{e.value.loading=!1}}function j(t){const{page:l,rowsPerPage:i}=t.pagination;e.value.pagination.page=l,e.value.pagination.rowsPerPage=i}function J(t){n.value={...t},h.value=!0}function F(t){g.value=t,e.value.selected=[t],_.value=!0}function H(){_.value=!0}async function L(t){x.value=!0;try{if(n.value?.id){const l=await K.updateDocument(m.value,n.value.id,t);l.error?s.notify({type:"negative",message:l.error,position:"top"}):(s.notify({type:"positive",message:"Запись успешно обновлена",position:"top"}),await C(),P())}else{const l=await K.createDocument(m.value,t);l.error?s.notify({type:"negative",message:l.error,position:"top"}):(s.notify({type:"positive",message:"Запись успешно создана",position:"top"}),await C(),P())}}finally{x.value=!1}}function P(){h.value=!1,n.value=null}async function d(){const t=e.value.selected.length>0?e.value.selected:g.value?[g.value]:[];if(t.length!==0)try{const l=t.map(T=>K.deleteDocument(m.value,T.id));(await Promise.all(l)).some(T=>T.error)?s.notify({type:"negative",message:"Произошла ошибка при удалении некоторых записей",position:"top"}):s.notify({type:"positive",message:`Успешно удалено ${t.length} записей`,position:"top"}),await C()}finally{_.value=!1,e.value.selected=[],g.value=null}}return(t,l)=>(y(),V(he,{class:"q-pa-md"},{default:c(()=>[v("div",Xe,[v("div",null,[v("div",Ye,S(u.value?.label||m.value),1),l[8]||(l[8]=v("div",{class:"text-subtitle1 text-grey-7"}," Управление записями в коллекции ",-1))]),o(k,{color:"primary",icon:"add",label:"Создать запись",onClick:l[0]||(l[0]=i=>h.value=!0)})]),o(M,{class:"q-mb-md",bordered:"",flat:""},{default:c(()=>[o(N,null,{default:c(()=>[v("div",Ze,[v("div",ea,[o(E,{modelValue:e.value.filter,"onUpdate:modelValue":[l[1]||(l[1]=i=>e.value.filter=i),l[2]||(l[2]=i=>B(String(i||"")))],debounce:"300",label:"Поиск",placeholder:"Поиск по всем полям...",clearable:"",filled:"",onClear:G},{append:c(()=>[o(I,{name:"search"})]),_:1},8,["modelValue"])]),v("div",aa,[o(k,{color:"secondary",icon:"refresh",padding:"12px",size:"md",onClick:C})]),e.value.selected.length>0?(y(),$("div",la,[o(k,{label:`Удалить (${e.value.selected.length})`,color:"negative",icon:"delete",padding:"12px",size:"md",onClick:H},null,8,["label"])])):q("",!0),v("div",ta,S(a.value),1)])]),_:1})]),_:1}),o(fe,{pagination:e.value.pagination,"onUpdate:pagination":l[3]||(l[3]=i=>e.value.pagination=i),selected:e.value.selected,"onUpdate:selected":l[4]||(l[4]=i=>e.value.selected=i),columns:u.value?.columns||[],loading:e.value.loading,rows:e.value.items,"row-key":"id",selection:"multiple",onRequest:j},{"body-cell-actions":c(i=>[o(te,{props:i},{default:c(()=>[o(k,{color:"primary",icon:"edit",dense:"",flat:"",round:"",onClick:D=>J(i.row)},{default:c(()=>[o(Z,null,{default:c(()=>l[9]||(l[9]=[Q("Редактировать")])),_:1,__:[9]})]),_:2},1032,["onClick"]),o(k,{color:"negative",icon:"delete",dense:"",flat:"",round:"",onClick:D=>F(i.row)},{default:c(()=>[o(Z,null,{default:c(()=>l[10]||(l[10]=[Q("Удалить")])),_:1,__:[10]})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),"body-cell-img":c(i=>[o(te,{props:i},{default:c(()=>[o(He,{alt:`Изображение ${i.row.id}`,"image-url":i.value},null,8,["alt","image-url"])]),_:2},1032,["props"])]),"no-data":c(()=>[v("div",oa,[o(I,{name:"inbox",size:"2em"}),l[11]||(l[11]=v("span",null," Нет данных для отображения ",-1))])]),_:1},8,["pagination","selected","columns","loading","rows"]),o(Ke,{modelValue:h.value,"onUpdate:modelValue":l[5]||(l[5]=i=>h.value=i),config:u.value,item:n.value,loading:x.value,onCancel:P,onSave:L},null,8,["modelValue","config","item","loading"]),o(ae,{modelValue:_.value,"onUpdate:modelValue":l[7]||(l[7]=i=>_.value=i)},{default:c(()=>[o(M,null,{default:c(()=>[o(N,{class:"row items-center"},{default:c(()=>[o(ye,{color:"negative",icon:"warning","text-color":"white"}),v("span",ra,S(w.value),1)]),_:1}),o(le,{align:"right"},{default:c(()=>[o(k,{label:"Отмена",flat:"",onClick:l[6]||(l[6]=i=>_.value=!1)}),o(k,{color:"negative",label:"Удалить",flat:"",onClick:d})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{ga as default};
