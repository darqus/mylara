import{d as te,r as $,c as j,w as G,y as w,f as v,q as m,K as V,X as R,W as ce,s as a,t as ue,v as B,x as N,e as q,T as D,p as o,af as W,S as F,B as T,a5 as $e,aj as Ve,a7 as se,$ as me,D as ae,a6 as qe,z as Ie,ak as Ue,al as De,am as Fe,an as Te,F as je,Y as _e,C as re,E as fe,P as ie,a as Qe,V as Ee,a3 as Ke,a9 as Re,ao as Ne,ap as oe,aq as Ae,Z as Le,ar as Oe,a0 as We}from"./vendor-CqOrBQm9.js";import{c as Se,g as Me}from"./index-BRhu6oku.js";import{r as ke,u as He,j as Ge,k as Je}from"./firebase-vendor-Dt--ACjN.js";import{a as Xe}from"./admin-config.service-D0X7YxHh.js";import{firestoreService as de}from"./firestore.service-BJWDe2Kw.js";const Ye={class:"base64-image-uploader"},Ze=["disabled"],ea={key:0,class:"base64-image-uploader__preview"},aa={class:"base64-image-uploader__info"},ta={class:"text-caption text-grey-7"},la={class:"text-caption text-grey-6"},oa={class:"base64-image-uploader__actions"},sa={key:1,class:"base64-image-uploader__placeholder"},na={class:"text-h6 text-grey-7 q-mt-sm"},ia={class:"text-caption text-grey-5 q-mt-sm"},ra={class:"text-caption text-grey-5"},ua={key:2,class:"base64-image-uploader__overlay"},da={key:0,class:"text-negative q-mt-sm"},ca={key:1,class:"base64-image-uploader__base64-info q-mt-sm"},ma={class:"q-pa-md bg-grey-1"},ga=te({name:"Base64ImageUploader",__name:"Base64ImageUploader",props:{modelValue:{default:null},disabled:{type:Boolean,default:!1},maxSizeKB:{default:2e3},allowedTypes:{default:()=>["image/jpeg","image/jpg","image/png","image/webp"]},maxWidth:{default:1920},maxHeight:{default:1080},quality:{default:.8},placeholder:{default:""},showPreview:{type:Boolean,default:!0},allowCopy:{type:Boolean,default:!0}},emits:["update:modelValue","upload-start","upload-success","upload-error"],setup(z,{emit:d}){const t=z,c=d,{loading:f,error:l,fileToBase64:k,formatFileSize:g,isValidBase64Image:P}=Se(),x=$(),I=$(!1),u=$(null),n=$(""),p=$(0),e=$(!1),i=j({get:()=>t.modelValue,set:_=>c("update:modelValue",_)}),J=j(()=>!!(i.value&&P(i.value))),le=j(()=>(t.allowedTypes||["image/jpeg","image/png","image/webp"]).map(h=>h.split("/")[1]?.toUpperCase()??"").filter(Boolean).join(", "));G(()=>t.modelValue,_=>{_&&P(_)?(u.value=_,n.value=C(_),p.value=Math.round(_.length*3/4)):S()},{immediate:!0});function Y(){!t.disabled&&x.value&&x.value.click()}function A(_){const h=_.target,L=h.files?.[0];L&&H(L),h&&(h.value="")}function M(){t.disabled||(I.value=!0)}function Z(){t.disabled||(I.value=!0)}function ne(){I.value=!1}function ee(_){if(I.value=!1,t.disabled)return;const h=_.dataTransfer?.files[0];h?.type.startsWith("image/")&&H(h)}async function H(_){c("upload-start");const h={maxSizeKB:t.maxSizeKB,allowedTypes:t.allowedTypes,...t.maxWidth&&{maxWidth:t.maxWidth},...t.maxHeight&&{maxHeight:t.maxHeight},quality:t.quality},L=await k(_,h);L?(i.value=L.base64,u.value=L.base64,n.value=_.name,p.value=L.compressedSize,c("upload-success",L.base64)):c("upload-error",l.value??"Ошибка загрузки изображения")}function b(){i.value=null,S()}function S(){u.value=null,n.value="",p.value=0}function C(_){const h=_.match(/^data:image\/([^;]+);base64,/);return h?`image.${h[1]==="jpeg"?"jpg":h[1]}`:"image.jpg"}async function E(){if(i.value)try{await navigator.clipboard.writeText(i.value),e.value=!0,setTimeout(()=>{e.value=!1},2e3)}catch(_){console.error("Ошибка копирования в буфер обмена:",_)}}function ge(){if(!i.value)return;const _=document.createElement("a");_.href=i.value,_.download=n.value||"image.jpg",document.body.appendChild(_),_.click(),document.body.removeChild(_)}return(_,h)=>(v(),w("div",Ye,[m("div",{class:ce([{"base64-image-uploader__upload-area--dragover":I.value,"base64-image-uploader__upload-area--disabled":_.disabled,"base64-image-uploader__upload-area--has-image":J.value},"base64-image-uploader__upload-area"]),onClick:Y,onDragenter:R(M,["prevent"]),onDragleave:R(ne,["prevent"]),onDragover:R(Z,["prevent"]),onDrop:R(ee,["prevent"])},[m("input",{ref_key:"fileInput",ref:x,disabled:_.disabled,accept:"image/*",style:{display:"none"},type:"file",onChange:A},null,40,Ze),_.showPreview&&u.value?(v(),w("div",ea,[a(ue,{alt:n.value,src:u.value,class:"rounded-borders",style:{"max-width":"100%","max-height":"300px"}},null,8,["alt","src"]),m("div",aa,[m("div",ta,B(n.value),1),m("div",la,B(N(g)(p.value)),1)]),m("div",oa,[_.allowCopy?(v(),q(D,{key:0,color:e.value?"positive":"primary",icon:e.value?"check":"content_copy",label:e.value?"Скопировано":"Копировать Base64",size:"sm",dense:"",outline:"",onClick:R(E,["stop"])},{default:o(()=>[a(W,null,{default:o(()=>h[0]||(h[0]=[F("Копировать base64 строку в буфер обмена")])),_:1,__:[0]})]),_:1},8,["color","icon","label"])):V("",!0),a(D,{color:"secondary",icon:"download",label:"Скачать",size:"sm",dense:"",outline:"",onClick:R(ge,["stop"])},{default:o(()=>[a(W,null,{default:o(()=>h[1]||(h[1]=[F("Скачать изображение как файл")])),_:1,__:[1]})]),_:1}),_.disabled?V("",!0):(v(),q(D,{key:1,color:"negative",icon:"delete",label:"Удалить",size:"sm",dense:"",outline:"",onClick:R(b,["stop"])},{default:o(()=>[a(W,null,{default:o(()=>h[2]||(h[2]=[F("Удалить изображение")])),_:1,__:[2]})]),_:1}))])])):(v(),w("div",sa,[a(T,{color:"grey-5",name:"image",size:"48px"}),m("div",na,B(_.placeholder||"Загрузить изображение"),1),h[3]||(h[3]=m("div",{class:"text-caption text-grey-6"}," Перетащите файл сюда или нажмите для выбора ",-1)),m("div",ia," Поддерживаемые форматы: "+B(le.value),1),m("div",ra," Максимальный размер: "+B(N(g)(_.maxSizeKB*1024)),1)])),N(f)?(v(),w("div",ua,[a($e,{thickness:.2,class:"q-ma-md",color:"primary",size:"50px",indeterminate:""}),h[4]||(h[4]=m("div",{class:"text-body2 text-grey-8"},"Обработка изображения...",-1))])):V("",!0)],34),N(l)?(v(),w("div",da,[a(T,{class:"q-mr-xs",name:"error"}),F(" "+B(N(l)),1)])):V("",!0),J.value&&i.value?(v(),w("div",ca,[a(Ve,{icon:"code",label:"Base64 строка",dense:""},{default:o(()=>[m("div",ma,[a(se,{"model-value":i.value,label:"Base64 данные",rows:"3",type:"textarea",filled:"",readonly:""},{append:o(()=>[_.allowCopy?(v(),q(D,{key:0,color:e.value?"positive":"primary",icon:e.value?"check":"content_copy",dense:"",flat:"",round:"",onClick:E},{default:o(()=>[a(W,null,{default:o(()=>h[5]||(h[5]=[F("Копировать в буфер обмена")])),_:1,__:[5]})]),_:1},8,["color","icon"])):V("",!0)]),_:1},8,["model-value"])])]),_:1})])):V("",!0)]))}});class va{storage;constructor(){const d=Me();if(!d)throw new Error("Firebase Storage not initialized");this.storage=d}async uploadImage(d,t={}){try{const c=this.validateImageFile(d,t);if(c)return{error:c};const f=t.filename??this.generateFileName(d),k=`${t.path??"images"}/${f}`,g=ke(this.storage,k),P=await He(g,d);return{url:await Ge(P.ref)}}catch(c){return console.error("Error uploading image:",c),{error:"Ошибка при загрузке изображения"}}}async uploadImageWithProgress(d,t={},c){try{const f=this.validateImageFile(d,t);if(f)return{error:f};const l=await this.uploadImage(d,t);return c&&l.url&&c({percentage:100,bytesTransferred:d.size,totalBytes:d.size}),l}catch(f){return console.error("Error uploading image with progress:",f),{error:"Ошибка при загрузке изображения"}}}async deleteImageByUrl(d){try{const t=this.extractPathFromUrl(d);if(!t)return{error:"Невозможно определить путь к файлу"};const c=ke(this.storage,t);return await Je(c),{}}catch(t){return console.error("Error deleting image:",t),{error:"Ошибка при удалении изображения"}}}validateImageFile(d,t){const c=t.allowedTypes??["image/jpeg","image/jpg","image/png","image/gif","image/webp"];if(!c.includes(d.type))return`Неподдерживаемый тип файла. Разрешены: ${c.map(k=>k.split("/")[1]).join(", ")}`;const f=t.maxSizeKB??5e3;return d.size/1024>f?`Размер файла слишком большой. Максимум: ${f}KB`:null}generateFileName(d){const t=d.name.split(".").pop()??"jpg",c=Date.now(),f=Math.random().toString(36).substring(2,10);return`${c}_${f}.${t}`}extractPathFromUrl(d){try{const t=new URL(d),{pathname:c}=t,f=c.match(/\/o\/(.+)/);return f?.[1]?decodeURIComponent(f[1]):null}catch{return null}}}const xe=new va,pa={class:"image-uploader"},fa=["disabled"],ya={key:0,class:"image-uploader__preview"},ba={class:"image-uploader__info"},_a={class:"text-caption text-grey-7"},ha={class:"text-caption text-grey-6"},wa={key:1,class:"image-uploader__placeholder"},ka={class:"text-caption text-grey-5"},xa={key:2,class:"image-uploader__overlay"},$a={class:"text-body2 text-grey-8"},Sa={key:0,class:"text-negative q-mt-sm"},Ba=te({name:"ImageUploader",__name:"ImageUploader",props:{modelValue:{default:null},disabled:{type:Boolean,default:!1},maxSizeKB:{default:5e3},allowedTypes:{default:()=>["image/jpeg","image/jpg","image/png","image/gif","image/webp"]},path:{default:"images"},placeholder:{default:""}},emits:["update:modelValue","upload-start","upload-success","upload-error"],setup(z,{emit:d}){const t=z,c=d,f=$(),l=$(!1),k=$(!1),g=$(0),P=$(""),x=$(null),I=$(""),u=$(0),n=j({get:()=>t.modelValue,set:b=>c("update:modelValue",b)});G(()=>t.modelValue,b=>{b&&b!==x.value?(x.value=b,I.value=H(b),u.value=0):b||Z()},{immediate:!0});function p(){!t.disabled&&f.value&&f.value.click()}function e(b){const C=b.target.files?.[0];C&&A(C)}function i(){t.disabled||(l.value=!0)}function J(){t.disabled||(l.value=!0)}function le(){l.value=!1}function Y(b){if(l.value=!1,t.disabled)return;const S=b.dataTransfer?.files[0];S?.type.startsWith("image/")&&A(S)}async function A(b){P.value="",k.value=!0,g.value=0,M(b),c("upload-start");const S={path:t.path,maxSizeKB:t.maxSizeKB,allowedTypes:t.allowedTypes};try{const C=await xe.uploadImageWithProgress(b,S,E=>{g.value=E.percentage});C.error?(P.value=C.error,c("upload-error",C.error),Z()):C.url&&(n.value=C.url,c("upload-success",C.url))}finally{k.value=!1,g.value=0}}function M(b){const S=new FileReader;S.onload=C=>{x.value=C.target?.result,I.value=b.name,u.value=b.size},S.readAsDataURL(b)}function Z(){x.value=null,I.value="",u.value=0}async function ne(){if(n.value){try{await xe.deleteImageByUrl(n.value)}catch(b){console.warn("Error deleting image:",b)}n.value=null,Z(),P.value=""}}function ee(b){if(b===0)return"0 Bytes";const S=1024,C=["Bytes","KB","MB","GB"],E=Math.floor(Math.log(b)/Math.log(S));return`${parseFloat((b/Math.pow(S,E)).toFixed(2))} ${C[E]}`}function H(b){try{const S=new URL(b),{pathname:C}=S,E=C.split("/");return E[E.length-1]??"image"}catch{return"image"}}return(b,S)=>(v(),w("div",pa,[m("div",{class:ce([{"image-uploader__upload-area--dragover":l.value,"image-uploader__upload-area--disabled":b.disabled},"image-uploader__upload-area"]),onClick:p,onDragenter:R(i,["prevent"]),onDragleave:R(le,["prevent"]),onDragover:R(J,["prevent"]),onDrop:R(Y,["prevent"])},[m("input",{ref_key:"fileInput",ref:f,disabled:b.disabled,accept:"image/*",style:{display:"none"},type:"file",onChange:e},null,40,fa),x.value?(v(),w("div",ya,[a(ue,{alt:I.value,src:x.value,class:"rounded-borders",style:{"max-width":"100%","max-height":"200px"}},null,8,["alt","src"]),m("div",ba,[m("div",_a,B(I.value),1),m("div",ha,B(ee(u.value)),1)]),b.disabled?V("",!0):(v(),q(D,{key:0,class:"image-uploader__remove-btn",color:"negative",icon:"close",size:"sm",dense:"",round:"",onClick:R(ne,["stop"])},{default:o(()=>[a(W,null,{default:o(()=>S[0]||(S[0]=[F("Удалить изображение")])),_:1,__:[0]})]),_:1}))])):(v(),w("div",wa,[a(T,{color:"grey-5",name:"cloud_upload",size:"48px"}),S[1]||(S[1]=m("div",{class:"text-h6 text-grey-7 q-mt-sm"},"Загрузить изображение",-1)),S[2]||(S[2]=m("div",{class:"text-caption text-grey-6"}," Перетащите файл сюда или нажмите для выбора ",-1)),S[3]||(S[3]=m("div",{class:"text-caption text-grey-5 q-mt-sm"}," Поддерживаемые форматы: JPG, PNG, GIF, WebP ",-1)),m("div",ka," Максимальный размер: "+B(ee((b.maxSizeKB??5e3)*1024)),1)])),k.value?(v(),w("div",xa,[a($e,{thickness:.2,value:g.value,class:"q-ma-md",color:"primary",size:"50px","track-color":"grey-3"},null,8,["value"]),m("div",$a," Загрузка... "+B(g.value)+"% ",1)])):V("",!0)],34),P.value?(v(),w("div",Sa,[a(T,{class:"q-mr-xs",name:"error"}),F(" "+B(P.value),1)])):V("",!0)]))}}),Ca={class:"text-h6"},za={class:"row"},Pa={key:3,class:"q-mb-md"},Va={class:"text-subtitle2 q-mb-sm"},qa={key:0,class:"text-negative"},Ia={key:7,class:"q-mb-md"},Ua={class:"text-subtitle2 q-mb-sm"},Da={key:0,class:"text-negative"},Fa={key:8,class:"q-mb-md"},Ta={class:"text-subtitle2 q-mb-sm"},ja={key:0,class:"text-negative"},Qa=te({name:"AdminFormDialog",__name:"AdminFormDialog",props:{modelValue:{type:Boolean},config:{},item:{},loading:{type:Boolean}},emits:["update:modelValue","save","cancel"],setup(z,{emit:d}){const t=z,c=d,f=$(),l=$({}),k=j(()=>!!t.item?.id);function g(n){const p=n.base64ImageOptions??{},e={maxSizeKB:p.maxSizeKB??2e3,quality:p.quality??.8,showPreview:p.showPreview??!0,allowCopy:p.allowCopy??!0,placeholder:n.placeholder??`Загрузите ${n.label.toLowerCase()}`};return p.allowedTypes&&(e.allowedTypes=p.allowedTypes),p.maxWidth&&(e.maxWidth=p.maxWidth),p.maxHeight&&(e.maxHeight=p.maxHeight),e}G(()=>t.item,n=>{n?l.value={...n}:P()},{immediate:!0}),G(()=>t.modelValue,n=>{n||P()});function P(){l.value={},t.config?.fields&&t.config.fields.forEach(n=>{if(n.defaultValue!==void 0){l.value[n.name]=n.defaultValue;return}switch(n.type){case"boolean":l.value[n.name]=!1;break;case"number":l.value[n.name]=0;break;case"editor":l.value[n.name]="";break;case"select":{const p=n.options?.[0];p?l.value[n.name]=p.value:l.value[n.name]="";break}default:l.value[n.name]=""}})}function x(n){const p=[];return n.required&&p.push(e=>n.type==="boolean"?!0:e!=null&&String(e).trim()!==""||"Поле обязательно для заполнения"),n.type==="email"&&p.push(e=>e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e))||"Введите корректный email":!0),n.type==="url"&&p.push(e=>{if(!e)return!0;try{return new URL(String(e)),!0}catch{return"Введите корректный URL"}}),n.rules&&p.push(...n.rules),p}function I(n){return n==="email"?"email":n==="url"?"url":"text"}async function u(){if(!f.value||!await f.value.validate())return;const p={...l.value};k.value||(delete p.id,delete p.createdAt,delete p.updatedAt),c("save",p)}return(n,p)=>(v(),q(me,{"model-value":n.modelValue,"onUpdate:modelValue":p[1]||(p[1]=e=>n.$emit("update:modelValue",e))},{default:o(()=>[a(re,{class:"dialog-standard"},{default:o(()=>[a(ae,null,{default:o(()=>[m("div",Ca,B(k.value?"Редактировать запись":"Создать запись"),1)]),_:1}),a(ae,{class:"q-pt-none"},{default:o(()=>[a(qe,{ref_key:"formRef",ref:f,onSubmit:u},{default:o(()=>[m("div",za,[(v(!0),w(je,null,Ie(n.config?.fields||[],e=>(v(),w("div",{key:e.name,class:"col-12"},[["text","email","url"].includes(e.type)?(v(),q(se,{key:0,label:e.label,"model-value":String(l.value[e.name]||""),placeholder:e.placeholder,required:e.required,rules:x(e),type:I(e.type),filled:"","onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["label","model-value","placeholder","required","rules","type","onUpdate:modelValue"])):e.type==="number"?(v(),q(se,{key:1,label:e.label,"model-value":Number(l.value[e.name]||0),placeholder:e.placeholder,required:e.required,rules:x(e),type:"number",filled:"","onUpdate:modelValue":i=>l.value[e.name]=Number(i)},null,8,["label","model-value","placeholder","required","rules","onUpdate:modelValue"])):e.type==="textarea"?(v(),q(se,{key:2,label:e.label,"model-value":String(l.value[e.name]||""),placeholder:e.placeholder,required:e.required,rules:x(e),rows:"4",type:"textarea",filled:"","onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["label","model-value","placeholder","required","rules","onUpdate:modelValue"])):e.type==="editor"?(v(),w("div",Pa,[m("div",Va,[F(B(e.label)+" ",1),e.required?(v(),w("span",qa," * ")):V("",!0)]),a(Ue,{"model-value":String(l.value[e.name]||""),placeholder:e.placeholder,toolbar:[["bold","italic","underline","strike"],["quote","unordered","ordered"],["left","center","right","justify"],["undo","redo"],["removeFormat","hr"]],"min-height":"200px","onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["model-value","placeholder","onUpdate:modelValue"])])):e.type==="date"?(v(),q(se,{key:4,label:e.label,"model-value":String(l.value[e.name]||""),required:e.required,rules:x(e),type:"date",filled:"","onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["label","model-value","required","rules","onUpdate:modelValue"])):e.type==="boolean"?(v(),q(De,{key:5,label:e.label,"model-value":!!l.value[e.name],"onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["label","model-value","onUpdate:modelValue"])):e.type==="select"?(v(),q(Fe,{key:6,label:e.label,"model-value":l.value[e.name],options:e.options||[],placeholder:e.placeholder,required:e.required,rules:x(e),"emit-value":"",filled:"","map-options":"","onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["label","model-value","options","placeholder","required","rules","onUpdate:modelValue"])):e.type==="image"?(v(),w("div",Ia,[m("div",Ua,[F(B(e.label)+" ",1),e.required?(v(),w("span",Da," * ")):V("",!0)]),a(Ba,{"model-value":l.value[e.name]?String(l.value[e.name]):null,"onUpdate:modelValue":i=>l.value[e.name]=i},null,8,["model-value","onUpdate:modelValue"])])):e.type==="base64-image"?(v(),w("div",Fa,[m("div",Ta,[F(B(e.label)+" ",1),e.required?(v(),w("span",ja," * ")):V("",!0)]),a(ga,Te({"model-value":l.value[e.name]?String(l.value[e.name]):null},{ref_for:!0},g(e),{"onUpdate:modelValue":i=>l.value[e.name]=i}),null,16,["model-value","onUpdate:modelValue"])])):V("",!0)]))),128))])]),_:1},512)]),_:1}),a(_e,{align:"right",class:"text-primary"},{default:o(()=>[a(D,{color:"grey-6",label:"Отмена",outline:"",onClick:p[0]||(p[0]=e=>n.$emit("cancel"))}),a(D,{loading:n.loading,color:"positive",label:"Сохранить",outline:"",onClick:u},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Ea={class:"base64-image-table-cell"},Ka={key:0,class:"base64-image-table-cell__overlay"},ye=te({name:"Base64ImageTableCell",__name:"Base64ImageTableCell",props:{base64Src:{default:null},base64:{default:null},alt:{default:"Изображение"},size:{default:60},clickable:{type:Boolean,default:!0},showAs:{default:"thumbnail"},rounded:{type:Boolean,default:!1}},emits:["click"],setup(z,{emit:d}){const t=z,c=d,{isValidBase64Image:f}=Se(),l=j(()=>t.base64Src??t.base64),k=j(()=>!!(l.value&&f(l.value))),g=j(()=>({width:`${t.size}px`,height:`${t.size}px`,minWidth:`${t.size}px`,minHeight:`${t.size}px`}));function P(){t.clickable&&k.value&&c("click")}return(x,I)=>(v(),w("div",Ea,[k.value?(v(),q(ue,{key:0,alt:x.alt,class:ce([{"base64-image-table-cell__image--clickable":x.clickable,"base64-image-table-cell__image--rounded":x.rounded},"base64-image-table-cell__image"]),src:l.value||void 0,style:fe(g.value),fit:"cover",loading:"lazy",onClick:P},{error:o(()=>[m("div",{style:fe(g.value),class:"base64-image-table-cell__error"},[a(T,{color:"grey-5",name:"broken_image",size:"24px"})],4)]),default:o(()=>[x.clickable?(v(),w("div",Ka,[a(T,{color:"white",name:"zoom_in",size:"20px"})])):V("",!0)]),_:1},8,["alt","class","src","style"])):(v(),w("div",{key:1,class:ce([{"base64-image-table-cell__placeholder--rounded":x.rounded},"base64-image-table-cell__placeholder"]),style:fe(g.value)},[a(T,{name:x.showAs==="icon"?"link":"image",color:"grey-5",size:"24px"},null,8,["name"])],6))]))}}),Ra={class:"image-table-cell"},Na={class:"image-table-cell__overlay"},Aa={class:"image-table-cell__error"},La={key:1,class:"image-table-cell__placeholder"},Oa={class:"image-table-cell__error-full"},Wa=te({name:"ImageTableCell",__name:"ImageTableCell",props:{imageUrl:{default:null},alt:{default:"Image"},size:{default:40}},setup(z){const d=z,t=$(!1);function c(){d.imageUrl&&(t.value=!0)}function f(){if(!d.imageUrl)return;const l=document.createElement("a");l.href=d.imageUrl,l.download=d.alt||"image",l.target="_blank",document.body.appendChild(l),l.click(),document.body.removeChild(l)}return(l,k)=>(v(),w("div",Ra,[l.imageUrl?(v(),q(ue,{key:0,alt:l.alt,src:l.imageUrl,class:"image-table-cell__thumbnail",fit:"cover",loading:"lazy",onClick:c},{error:o(()=>[m("div",Aa,[a(T,{color:"grey-5",name:"broken_image",size:"24px"})])]),default:o(()=>[m("div",Na,[a(T,{color:"white",name:"zoom_in",size:"20px"})])]),_:1},8,["alt","src"])):(v(),w("div",La,[a(T,{color:"grey-5",name:"image",size:"24px"})])),a(me,{modelValue:t.value,"onUpdate:modelValue":k[1]||(k[1]=g=>t.value=g)},{default:o(()=>[a(re,{class:"image-table-cell__dialog"},{default:o(()=>[a(ae,{class:"q-pa-none"},{default:o(()=>[a(ue,{alt:l.alt,src:l.imageUrl||void 0,fit:"contain",style:{"max-width":"80vw","max-height":"80vh"}},{error:o(()=>[m("div",Oa,[a(T,{color:"grey-5",name:"broken_image",size:"48px"}),k[2]||(k[2]=m("div",{class:"text-grey-7 q-mt-sm"}," Ошибка загрузки изображения ",-1))])]),_:1},8,["alt","src"])]),_:1}),a(_e,{align:"right"},{default:o(()=>[a(D,{label:"Закрыть",flat:"",onClick:k[0]||(k[0]=g=>t.value=!1)}),l.imageUrl?(v(),q(D,{key:0,color:"primary",icon:"download",label:"Скачать",flat:"",onClick:f})):V("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}}),Ma={key:0,class:"text-caption text-grey-6 q-ml-sm"},Ha={class:"text-body2"},Ga={class:"q-mt-xs q-mb-none"},Ja={key:0},Xa={key:1},Ya={key:2},Za=te({__name:"TableSettingsIndicator",props:{settings:{}},setup(z){const d=z,t=j(()=>(d.settings.sortBy??!1)||(d.settings.filter??!1)||d.settings.rowsPerPage!==10||d.settings.page>1);return(c,f)=>t.value?(v(),w("div",Ma,[a(T,{class:"q-mr-xs",name:"settings",size:"12px"}),f[1]||(f[1]=F(" Настройки сохранены ")),a(W,null,{default:o(()=>[m("div",Ha,[f[0]||(f[0]=m("div",null,"Сохраненные настройки:",-1)),m("ul",Ga,[c.settings.sortBy?(v(),w("li",Ja," Сортировка: "+B(c.settings.sortBy)+" "+B(c.settings.descending?"(убыв.)":"(возр.)"),1)):V("",!0),c.settings.filter?(v(),w("li",Xa,'Фильтр: "'+B(c.settings.filter)+'"',1)):V("",!0),m("li",null,"Записей на странице: "+B(c.settings.rowsPerPage),1),c.settings.page>1?(v(),w("li",Ya," Текущая страница: "+B(c.settings.page),1)):V("",!0)])])]),_:1})])):V("",!0)}}),be={page:1,rowsPerPage:10,filter:""};function et(z){const d=j(()=>`table-settings-${String(N(z))}`);function t(){try{const e=ie.getItem(d.value);if(e&&typeof e=="object"&&e!==null){const i=e;return{...be,...typeof i.page=="number"&&i.page>0&&{page:i.page},...typeof i.rowsPerPage=="number"&&i.rowsPerPage>0&&{rowsPerPage:i.rowsPerPage},...typeof i.sortBy=="string"&&i.sortBy.length>0&&{sortBy:i.sortBy},...typeof i.descending=="boolean"&&{descending:i.descending},...typeof i.filter=="string"&&{filter:i.filter},...Array.isArray(i.visibleColumns)&&{visibleColumns:i.visibleColumns}}}}catch(e){console.warn(`Failed to load table settings for ${String(N(z))}:`,e)}return{...be}}function c(e){try{ie.set(d.value,e)}catch(i){console.warn(`Failed to save table settings for ${String(N(z))}:`,i)}}function f(){try{ie.remove(d.value)}catch(e){console.warn(`Failed to clear table settings for ${String(N(z))}:`,e)}}function l(){return ie.has(d.value)}function k(){try{const e=ie.getItem(d.value);if(e)return JSON.stringify(e).length}catch(e){console.warn(`Failed to calculate storage size for ${String(N(z))}:`,e)}return 0}const g=$(t());G(()=>N(z),()=>{const e=t();Object.assign(g.value,e)}),G(g,e=>{c(e)},{deep:!0});function P(e){g.value.page=e.page,g.value.rowsPerPage=e.rowsPerPage,e.sortBy!==void 0&&(g.value.sortBy=e.sortBy),e.descending!==void 0&&(g.value.descending=e.descending)}function x(e){g.value.filter=e,g.value.page=1}function I(e){g.value.visibleColumns=e}function u(){g.value={...be}}const n=j(()=>({page:g.value.page,rowsPerPage:g.value.rowsPerPage,rowsNumber:0,sortBy:g.value.sortBy,descending:g.value.descending}));function p(){const e=t();Object.assign(g.value,e)}return{settings:g,paginationSettings:n,updatePagination:P,updateFilter:x,updateVisibleColumns:I,resetSettings:u,clearSettings:f,hasSettings:l,getStorageSize:k,loadSettings:t,saveSettings:c,reloadSettings:p}}const at={class:"row items-center justify-between q-mb-md"},tt={class:"text-h4"},lt={class:"row q-gutter-md items-center"},ot={class:"col-12 col-md-6"},st={class:"col-auto"},nt={class:"col-auto"},it={key:0,class:"col-auto"},rt={class:"col-auto text-grey-6"},ut={class:"text-center"},dt=["title"],ct={class:"full-width row flex-center text-grey-7 q-gutter-sm"},mt={class:"q-ml-sm"},gt=["src"],_t=te({name:"AdminCollectionPage",__name:"AdminCollectionPage",setup(z){const d=Ee(),t=Re(),c=j(()=>t.params.collection),f=j(()=>Xe(c.value));function l(y){return f.value?.fields.find(s=>s.name===y)?.type}const{settings:k,paginationSettings:g,updatePagination:P,updateFilter:x,resetSettings:I}=et(c),u=$({items:[],loading:!1,pagination:{page:g.value.page,rowsPerPage:g.value.rowsPerPage,rowsNumber:0,...g.value.sortBy&&{sortBy:g.value.sortBy},...g.value.descending!==void 0&&{descending:g.value.descending}},filter:k.value.filter,selected:[]}),n=$([]),p=$([]),e=$(!1),i=$(!1),J=$(!1),le=$(""),Y=$(!1),A=$(null),M=$(null),Z=j(()=>u.value.filter.trim()?`Найдено: ${p.value.length} из ${n.value.length}`:`Всего записей: ${n.value.length}`),ne=j(()=>u.value.selected.length>1?`Вы действительно хотите удалить ${u.value.selected.length} записей?`:"Вы действительно хотите удалить эту запись?");Qe(()=>{ee(),C()}),G(()=>c.value,(y,s)=>{y!==s&&y&&(ee(),s&&f.value?.label&&d.notify({type:"info",message:`Переключено на: ${f.value.label}`,position:"top",timeout:1e3}),C())}),G(()=>u.value.filter,y=>{x(y)}),G(()=>u.value.pagination,y=>{P(y)},{deep:!0});function ee(){u.value={items:[],loading:!0,pagination:{page:g.value.page,rowsPerPage:g.value.rowsPerPage,rowsNumber:0,...g.value.sortBy&&{sortBy:g.value.sortBy},...g.value.descending!==void 0&&{descending:g.value.descending}},filter:k.value.filter,selected:[]},n.value=[],p.value=[],e.value=!1,i.value=!1,A.value=null,M.value=null}function H(y){if(!y.trim())p.value=[...n.value];else{const s=y.toLowerCase(),r=f.value?.fields?.map(U=>U.name)??[];p.value=n.value.filter(U=>r.some(O=>{const Q=U[O];return Q==null?!1:String(Q).toLowerCase().includes(s)}))}b(),u.value.pagination.rowsNumber=p.value.length,u.value.pagination.page=1}function b(){if(!u.value.pagination.sortBy){u.value.items=p.value;return}const{sortBy:y}=u.value.pagination,s=u.value.pagination.descending??!1,r=[...p.value].sort((U,O)=>{const Q=U[y],K=O[y];if(Q==null)return K==null?0:s?1:-1;if(K==null)return s?-1:1;if(typeof Q=="string"&&typeof K=="string"){const X=Q.localeCompare(K,"ru",{numeric:!0,sensitivity:"base"});return s?-X:X}if(typeof Q=="number"&&typeof K=="number"){const X=Q-K;return s?-X:X}if(Q instanceof Date&&K instanceof Date){const X=Q.getTime()-K.getTime();return s?-X:X}const ze=String(Q),Pe=String(K),we=ze.localeCompare(Pe,"ru",{numeric:!0,sensitivity:"base"});return s?-we:we});u.value.items=r}function S(){u.value.filter="",H("")}async function C(){if(!f.value){d.notify({type:"negative",message:"Конфигурация коллекции не найдена",position:"top"});return}u.value.loading=!0;try{const y=await de.getCollection(c.value);y.error?d.notify({type:"negative",message:y.error,position:"top"}):(n.value=y.items,H(u.value.filter))}finally{u.value.loading=!1}}function E(y){const{page:s,rowsPerPage:r,sortBy:U,descending:O}=y.pagination;u.value.pagination.page=s,u.value.pagination.rowsPerPage=r,(u.value.pagination.sortBy!==U||u.value.pagination.descending!==O)&&(U!==void 0&&(u.value.pagination.sortBy=U),O!==void 0&&(u.value.pagination.descending=O),b()),P(y.pagination)}function ge(y){A.value={...y},e.value=!0}function _(y){M.value=y,u.value.selected=[y],i.value=!0}function h(){i.value=!0}function L(){I(),u.value.pagination={page:1,rowsPerPage:10,rowsNumber:u.value.pagination.rowsNumber},u.value.filter="",H(""),d.notify({type:"positive",message:"Настройки таблицы сброшены",position:"top"})}async function Be(y){Y.value=!0;try{if(A.value?.id){const s=await de.updateDocument(c.value,A.value.id,y);s.error?d.notify({type:"negative",message:s.error,position:"top"}):(d.notify({type:"positive",message:"Запись успешно обновлена",position:"top"}),await C(),ve())}else{const s=await de.createDocument(c.value,y);s.error?d.notify({type:"negative",message:s.error,position:"top"}):(d.notify({type:"positive",message:"Запись успешно создана",position:"top"}),await C(),ve())}}finally{Y.value=!1}}function ve(){e.value=!1,A.value=null}async function Ce(){const y=u.value.selected.length>0?u.value.selected:M.value?[M.value]:[];if(y.length!==0)try{const s=y.map(O=>de.deleteDocument(c.value,O.id));(await Promise.all(s)).some(O=>O.error)?d.notify({type:"negative",message:"Произошла ошибка при удалении некоторых записей",position:"top"}):d.notify({type:"positive",message:`Успешно удалено ${y.length} записей`,position:"top"}),await C()}finally{i.value=!1,u.value.selected=[],M.value=null}}function pe(y){le.value=y,J.value=!0}function he(y){if(!y)return"";let s;typeof y=="string"?s=y:typeof y=="number"||typeof y=="boolean"?s=String(y):s=JSON.stringify(y);let r=s.replace(/<[^>]*>/g,"");const U=document.createElement("textarea");return U.innerHTML=r,r=U.value.trim(),r.length>80?`${r.substring(0,80)}...`:r}return(y,s)=>(v(),q(Ke,{class:"q-pa-md admin-collection-page"},{default:o(()=>[m("div",at,[m("div",null,[m("div",tt,B(f.value?.label||c.value),1),s[9]||(s[9]=m("div",{class:"text-subtitle1 text-grey-7"}," Управление записями в коллекции ",-1))]),a(D,{color:"primary",icon:"add",label:"Создать запись",onClick:s[0]||(s[0]=r=>e.value=!0)})]),a(re,{class:"q-mb-md",bordered:"",flat:""},{default:o(()=>[a(ae,null,{default:o(()=>[m("div",lt,[m("div",ot,[a(se,{modelValue:u.value.filter,"onUpdate:modelValue":[s[1]||(s[1]=r=>u.value.filter=r),s[2]||(s[2]=r=>H(String(r||"")))],debounce:"300",label:"Поиск",placeholder:"Поиск по всем полям...",clearable:"",filled:"",onClear:S},{append:o(()=>[a(T,{name:"search"})]),_:1},8,["modelValue"])]),m("div",st,[a(D,{color:"secondary",icon:"refresh",padding:"12px",size:"md",onClick:C})]),m("div",nt,[a(D,{color:"grey",icon:"settings_backup_restore",padding:"12px",size:"md",onClick:L},{default:o(()=>[a(W,null,{default:o(()=>s[10]||(s[10]=[F("Сбросить настройки таблицы")])),_:1,__:[10]})]),_:1})]),u.value.selected.length>0?(v(),w("div",it,[a(D,{label:`Удалить (${u.value.selected.length})`,color:"negative",icon:"delete",padding:"12px",size:"md",onClick:h},null,8,["label"])])):V("",!0),m("div",rt,[F(B(Z.value)+" ",1),a(Za,{settings:N(k)},null,8,["settings"])])])]),_:1})]),_:1}),a(Ne,{pagination:u.value.pagination,"onUpdate:pagination":s[3]||(s[3]=r=>u.value.pagination=r),selected:u.value.selected,"onUpdate:selected":s[4]||(s[4]=r=>u.value.selected=r),columns:f.value?.columns||[],loading:u.value.loading,rows:u.value.items,class:"products-table","row-key":"id",selection:"multiple","server-pagination":"",onRequest:E},{"body-cell-actions":o(r=>[a(oe,{props:r},{default:o(()=>[a(D,{color:"primary",icon:"edit",dense:"",flat:"",round:"",onClick:U=>ge(r.row)},{default:o(()=>[a(W,null,{default:o(()=>s[11]||(s[11]=[F("Редактировать")])),_:1,__:[11]})]),_:2},1032,["onClick"]),a(D,{color:"negative",icon:"delete",dense:"",flat:"",round:"",onClick:U=>_(r.row)},{default:o(()=>[a(W,null,{default:o(()=>s[12]||(s[12]=[F("Удалить")])),_:1,__:[12]})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),"body-cell-img":o(r=>[a(oe,{props:r},{default:o(()=>[l("img")==="base64-image"?(v(),q(ye,{key:0,alt:`${r.row.label||"Продукт"} - изображение`,"base64-src":r.value,clickable:!0,size:70,"show-as":"thumbnail",onClick:U=>pe(r.value)},null,8,["alt","base64-src","onClick"])):(v(),q(Wa,{key:1,alt:`${r.row.label||"Продукт"} - изображение`,"image-url":r.value},null,8,["alt","image-url"]))]),_:2},1032,["props"])]),"body-cell-link":o(r=>[a(oe,{props:r},{default:o(()=>[m("div",ut,[r.value?(v(),q(T,{key:0,color:"primary",name:"link",size:"20px"},{default:o(()=>[a(W,null,{default:o(()=>[F(B(r.value),1)]),_:2},1024)]),_:2},1024)):(v(),q(T,{key:1,color:"grey-4",name:"link_off",size:"20px"},{default:o(()=>[a(W,null,{default:o(()=>s[13]||(s[13]=[F("Нет ссылки")])),_:1,__:[13]})]),_:1}))])]),_:2},1032,["props"])]),"body-cell-info":o(r=>[a(oe,{props:r},{default:o(()=>[m("div",{title:he(r.value),class:"info-cell-content"},B(he(r.value)),9,dt)]),_:2},1032,["props"])]),"body-cell-image":o(r=>[a(oe,{props:r},{default:o(()=>[a(ye,{alt:`Изображение ${r.row.id}`,base64:r.value,clickable:!0,size:60,onClick:U=>pe(r.value)},null,8,["alt","base64","onClick"])]),_:2},1032,["props"])]),"body-cell-thumbnail":o(r=>[a(oe,{props:r},{default:o(()=>[a(ye,{alt:`Миниатюра ${r.row.id}`,base64:r.value,clickable:!0,size:40,onClick:U=>pe(r.value)},null,8,["alt","base64","onClick"])]),_:2},1032,["props"])]),"no-data":o(()=>[m("div",ct,[a(T,{name:"inbox",size:"2em"}),s[14]||(s[14]=m("span",null,"Нет данных для отображения",-1))])]),_:1},8,["pagination","selected","columns","loading","rows"]),a(Qa,{modelValue:e.value,"onUpdate:modelValue":s[5]||(s[5]=r=>e.value=r),config:f.value,item:A.value,loading:Y.value,onCancel:ve,onSave:Be},null,8,["modelValue","config","item","loading"]),a(me,{modelValue:i.value,"onUpdate:modelValue":s[7]||(s[7]=r=>i.value=r)},{default:o(()=>[a(re,null,{default:o(()=>[a(ae,{class:"row items-center"},{default:o(()=>[a(Ae,{color:"negative",icon:"warning","text-color":"white"}),m("span",mt,B(ne.value),1)]),_:1}),a(_e,{align:"right"},{default:o(()=>[a(D,{label:"Отмена",flat:"",onClick:s[6]||(s[6]=r=>i.value=!1)}),a(D,{color:"negative",label:"Удалить",flat:"",onClick:Ce})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(me,{modelValue:J.value,"onUpdate:modelValue":s[8]||(s[8]=r=>J.value=r),maximized:""},{default:o(()=>[a(re,{class:"bg-dark text-white"},{default:o(()=>[a(ae,{class:"row items-center q-pb-none"},{default:o(()=>[s[15]||(s[15]=m("div",{class:"text-h6"},"Просмотр изображения",-1)),a(Oe),Le(a(D,{icon:"close",dense:"",flat:"",round:""},null,512),[[We]])]),_:1,__:[15]}),a(ae,{class:"q-pt-none flex flex-center"},{default:o(()=>[m("img",{src:le.value,alt:"Просмотр изображения",style:{"max-width":"100%","max-height":"90vh","object-fit":"contain"}},null,8,gt)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{_t as default};
