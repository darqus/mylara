import{d as te,r as k,c as Q,w as G,y as w,f as g,q as m,K as z,s as a,t as re,v as C,x as N,e as U,T as q,$ as R,p as i,S as F,af as H,B as j,a5 as ke,Z as xe,a7 as oe,aj as ze,Y as ce,D as ae,a6 as Ve,z as qe,F as Ie,W as ye,C as ie,ak as Ue,al as De,am as Fe,E as he,P as ne,V as Te,a9 as je,a as Qe,an as Ee,ao as ue,ap as Ke,X as Re,aq as Ne,a0 as Le,a3 as Ae}from"./vendor-BWNmmB4S.js";import{c as $e,g as We}from"./index-WC_OeSB9.js";import{r as _e,u as Oe,j as Me,k as He}from"./firebase-vendor-CJeZ2BEb.js";import{a as Ge}from"./admin-config.service-B9kxW-MT.js";import{firestoreService as de}from"./firestore.service-Bwc5dqkm.js";const Je={class:"base64-image-uploader"},Xe=["disabled"],Ye={key:0,class:"base64-image-uploader__preview"},Ze={class:"base64-image-uploader__info"},ea={class:"text-caption text-grey-7"},aa={class:"text-caption text-grey-6"},ta={class:"base64-image-uploader__actions"},la={key:1,class:"base64-image-uploader__placeholder"},oa={class:"text-h6 text-grey-7 q-mt-sm"},sa={class:"text-caption text-grey-5 q-mt-sm"},na={class:"text-caption text-grey-5"},ia={key:2,class:"base64-image-uploader__overlay"},ra={key:0,class:"text-negative q-mt-sm"},ua={key:1,class:"base64-image-uploader__base64-info q-mt-sm"},da={class:"q-pa-md bg-grey-1"},ca=te({name:"Base64ImageUploader",__name:"Base64ImageUploader",props:{modelValue:{default:null},disabled:{type:Boolean,default:!1},maxSizeKB:{default:2e3},allowedTypes:{default:()=>["image/jpeg","image/jpg","image/png","image/webp"]},maxWidth:{default:1920},maxHeight:{default:1080},quality:{default:.8},placeholder:{default:""},showPreview:{type:Boolean,default:!0},allowCopy:{type:Boolean,default:!0}},emits:["update:modelValue","upload-start","upload-success","upload-error"],setup(B,{emit:s}){const t=B,u=s,{loading:v,error:l,fileToBase64:x,formatFileSize:d,isValidBase64Image:V}=$e(),P=k(),I=k(!1),o=k(null),c=k(""),p=k(0),e=k(!1),n=Q({get:()=>t.modelValue,set:b=>u("update:modelValue",b)}),J=Q(()=>!!(n.value&&V(n.value))),le=Q(()=>(t.allowedTypes||["image/jpeg","image/png","image/webp"]).map(_=>_.split("/")[1]?.toUpperCase()??"").filter(Boolean).join(", "));G(()=>t.modelValue,b=>{b&&V(b)?(o.value=b,c.value=S(b),p.value=Math.round(b.length*3/4)):$()},{immediate:!0});function Y(){!t.disabled&&P.value&&P.value.click()}function L(b){const _=b.target,A=_.files?.[0];A&&M(A),_&&(_.value="")}function O(){t.disabled||(I.value=!0)}function Z(){t.disabled||(I.value=!0)}function se(){I.value=!1}function ee(b){if(I.value=!1,t.disabled)return;const _=b.dataTransfer?.files[0];_?.type.startsWith("image/")&&M(_)}async function M(b){u("upload-start");const _={maxSizeKB:t.maxSizeKB,allowedTypes:t.allowedTypes,...t.maxWidth&&{maxWidth:t.maxWidth},...t.maxHeight&&{maxHeight:t.maxHeight},quality:t.quality},A=await x(b,_);A?(n.value=A.base64,o.value=A.base64,c.value=b.name,p.value=A.compressedSize,u("upload-success",A.base64)):u("upload-error",l.value??"Ошибка загрузки изображения")}function y(){n.value=null,$()}function $(){o.value=null,c.value="",p.value=0}function S(b){const _=b.match(/^data:image\/([^;]+);base64,/);return _?`image.${_[1]==="jpeg"?"jpg":_[1]}`:"image.jpg"}async function E(){if(n.value)try{await navigator.clipboard.writeText(n.value),e.value=!0,setTimeout(()=>{e.value=!1},2e3)}catch(b){console.error("Ошибка копирования в буфер обмена:",b)}}function me(){if(!n.value)return;const b=document.createElement("a");b.href=n.value,b.download=c.value||"image.jpg",document.body.appendChild(b),b.click(),document.body.removeChild(b)}return(b,_)=>(g(),w("div",Je,[m("div",{class:xe([{"base64-image-uploader__upload-area--dragover":I.value,"base64-image-uploader__upload-area--disabled":b.disabled,"base64-image-uploader__upload-area--has-image":J.value},"base64-image-uploader__upload-area"]),onClick:Y,onDragenter:R(O,["prevent"]),onDragleave:R(se,["prevent"]),onDragover:R(Z,["prevent"]),onDrop:R(ee,["prevent"])},[m("input",{ref_key:"fileInput",ref:P,disabled:b.disabled,accept:"image/*",style:{display:"none"},type:"file",onChange:L},null,40,Xe),b.showPreview&&o.value?(g(),w("div",Ye,[a(re,{alt:c.value,src:o.value,class:"rounded-borders",style:{"max-width":"100%","max-height":"300px"}},null,8,["alt","src"]),m("div",Ze,[m("div",ea,C(c.value),1),m("div",aa,C(N(d)(p.value)),1)]),m("div",ta,[b.allowCopy?(g(),U(q,{key:0,color:e.value?"positive":"primary",icon:e.value?"check":"content_copy",label:e.value?"Скопировано":"Копировать Base64",size:"sm",dense:"",outline:"",onClick:R(E,["stop"])},{default:i(()=>[a(H,null,{default:i(()=>_[0]||(_[0]=[F("Копировать base64 строку в буфер обмена")])),_:1,__:[0]})]),_:1},8,["color","icon","label"])):z("",!0),a(q,{color:"secondary",icon:"download",label:"Скачать",size:"sm",dense:"",outline:"",onClick:R(me,["stop"])},{default:i(()=>[a(H,null,{default:i(()=>_[1]||(_[1]=[F("Скачать изображение как файл")])),_:1,__:[1]})]),_:1}),b.disabled?z("",!0):(g(),U(q,{key:1,color:"negative",icon:"delete",label:"Удалить",size:"sm",dense:"",outline:"",onClick:R(y,["stop"])},{default:i(()=>[a(H,null,{default:i(()=>_[2]||(_[2]=[F("Удалить изображение")])),_:1,__:[2]})]),_:1}))])])):(g(),w("div",la,[a(j,{color:"grey-5",name:"image",size:"48px"}),m("div",oa,C(b.placeholder||"Загрузить изображение"),1),_[3]||(_[3]=m("div",{class:"text-caption text-grey-6"}," Перетащите файл сюда или нажмите для выбора ",-1)),m("div",sa," Поддерживаемые форматы: "+C(le.value),1),m("div",na," Максимальный размер: "+C(N(d)(b.maxSizeKB*1024)),1)])),N(v)?(g(),w("div",ia,[a(ke,{thickness:.2,class:"q-ma-md",color:"primary",size:"50px",indeterminate:""}),_[4]||(_[4]=m("div",{class:"text-body2 text-grey-8"},"Обработка изображения...",-1))])):z("",!0)],34),N(l)?(g(),w("div",ra,[a(j,{class:"q-mr-xs",name:"error"}),F(" "+C(N(l)),1)])):z("",!0),J.value&&n.value?(g(),w("div",ua,[a(ze,{icon:"code",label:"Base64 строка",dense:""},{default:i(()=>[m("div",da,[a(oe,{"model-value":n.value,label:"Base64 данные",rows:"3",type:"textarea",filled:"",readonly:""},{append:i(()=>[b.allowCopy?(g(),U(q,{key:0,color:e.value?"positive":"primary",icon:e.value?"check":"content_copy",dense:"",flat:"",round:"",onClick:E},{default:i(()=>[a(H,null,{default:i(()=>_[5]||(_[5]=[F("Копировать в буфер обмена")])),_:1,__:[5]})]),_:1},8,["color","icon"])):z("",!0)]),_:1},8,["model-value"])])]),_:1})])):z("",!0)]))}});class ma{storage;constructor(){const s=We();if(!s)throw new Error("Firebase Storage not initialized");this.storage=s}async uploadImage(s,t={}){try{const u=this.validateImageFile(s,t);if(u)return{error:u};const v=t.filename??this.generateFileName(s),x=`${t.path??"images"}/${v}`,d=_e(this.storage,x),V=await Oe(d,s);return{url:await Me(V.ref)}}catch(u){return console.error("Error uploading image:",u),{error:"Ошибка при загрузке изображения"}}}async uploadImageWithProgress(s,t={},u){try{const v=this.validateImageFile(s,t);if(v)return{error:v};const l=await this.uploadImage(s,t);return u&&l.url&&u({percentage:100,bytesTransferred:s.size,totalBytes:s.size}),l}catch(v){return console.error("Error uploading image with progress:",v),{error:"Ошибка при загрузке изображения"}}}async deleteImageByUrl(s){try{const t=this.extractPathFromUrl(s);if(!t)return{error:"Невозможно определить путь к файлу"};const u=_e(this.storage,t);return await He(u),{}}catch(t){return console.error("Error deleting image:",t),{error:"Ошибка при удалении изображения"}}}validateImageFile(s,t){const u=t.allowedTypes??["image/jpeg","image/jpg","image/png","image/gif","image/webp"];if(!u.includes(s.type))return`Неподдерживаемый тип файла. Разрешены: ${u.map(x=>x.split("/")[1]).join(", ")}`;const v=t.maxSizeKB??5e3;return s.size/1024>v?`Размер файла слишком большой. Максимум: ${v}KB`:null}generateFileName(s){const t=s.name.split(".").pop()??"jpg",u=Date.now(),v=Math.random().toString(36).substring(2,10);return`${u}_${v}.${t}`}extractPathFromUrl(s){try{const t=new URL(s),{pathname:u}=t,v=u.match(/\/o\/(.+)/);return v?.[1]?decodeURIComponent(v[1]):null}catch{return null}}}const we=new ma,ga={class:"image-uploader"},va=["disabled"],pa={key:0,class:"image-uploader__preview"},fa={class:"image-uploader__info"},ya={class:"text-caption text-grey-7"},ba={class:"text-caption text-grey-6"},ha={key:1,class:"image-uploader__placeholder"},_a={class:"text-caption text-grey-5"},wa={key:2,class:"image-uploader__overlay"},ka={class:"text-body2 text-grey-8"},xa={key:0,class:"text-negative q-mt-sm"},$a=te({name:"ImageUploader",__name:"ImageUploader",props:{modelValue:{default:null},disabled:{type:Boolean,default:!1},maxSizeKB:{default:5e3},allowedTypes:{default:()=>["image/jpeg","image/jpg","image/png","image/gif","image/webp"]},path:{default:"images"},placeholder:{default:""}},emits:["update:modelValue","upload-start","upload-success","upload-error"],setup(B,{emit:s}){const t=B,u=s,v=k(),l=k(!1),x=k(!1),d=k(0),V=k(""),P=k(null),I=k(""),o=k(0),c=Q({get:()=>t.modelValue,set:y=>u("update:modelValue",y)});G(()=>t.modelValue,y=>{y&&y!==P.value?(P.value=y,I.value=M(y),o.value=0):y||Z()},{immediate:!0});function p(){!t.disabled&&v.value&&v.value.click()}function e(y){const S=y.target.files?.[0];S&&L(S)}function n(){t.disabled||(l.value=!0)}function J(){t.disabled||(l.value=!0)}function le(){l.value=!1}function Y(y){if(l.value=!1,t.disabled)return;const $=y.dataTransfer?.files[0];$?.type.startsWith("image/")&&L($)}async function L(y){V.value="",x.value=!0,d.value=0,O(y),u("upload-start");const $={path:t.path,maxSizeKB:t.maxSizeKB,allowedTypes:t.allowedTypes};try{const S=await we.uploadImageWithProgress(y,$,E=>{d.value=E.percentage});S.error?(V.value=S.error,u("upload-error",S.error),Z()):S.url&&(c.value=S.url,u("upload-success",S.url))}finally{x.value=!1,d.value=0}}function O(y){const $=new FileReader;$.onload=S=>{P.value=S.target?.result,I.value=y.name,o.value=y.size},$.readAsDataURL(y)}function Z(){P.value=null,I.value="",o.value=0}async function se(){if(c.value){try{await we.deleteImageByUrl(c.value)}catch(y){console.warn("Error deleting image:",y)}c.value=null,Z(),V.value=""}}function ee(y){if(y===0)return"0 Bytes";const $=1024,S=["Bytes","KB","MB","GB"],E=Math.floor(Math.log(y)/Math.log($));return`${parseFloat((y/Math.pow($,E)).toFixed(2))} ${S[E]}`}function M(y){try{const $=new URL(y),{pathname:S}=$,E=S.split("/");return E[E.length-1]??"image"}catch{return"image"}}return(y,$)=>(g(),w("div",ga,[m("div",{class:xe([{"image-uploader__upload-area--dragover":l.value,"image-uploader__upload-area--disabled":y.disabled},"image-uploader__upload-area"]),onClick:p,onDragenter:R(n,["prevent"]),onDragleave:R(le,["prevent"]),onDragover:R(J,["prevent"]),onDrop:R(Y,["prevent"])},[m("input",{ref_key:"fileInput",ref:v,disabled:y.disabled,accept:"image/*",style:{display:"none"},type:"file",onChange:e},null,40,va),P.value?(g(),w("div",pa,[a(re,{alt:I.value,src:P.value,class:"rounded-borders",style:{"max-width":"100%","max-height":"200px"}},null,8,["alt","src"]),m("div",fa,[m("div",ya,C(I.value),1),m("div",ba,C(ee(o.value)),1)]),y.disabled?z("",!0):(g(),U(q,{key:0,class:"image-uploader__remove-btn",color:"negative",icon:"close",size:"sm",dense:"",round:"",onClick:R(se,["stop"])},{default:i(()=>[a(H,null,{default:i(()=>$[0]||($[0]=[F("Удалить изображение")])),_:1,__:[0]})]),_:1}))])):(g(),w("div",ha,[a(j,{color:"grey-5",name:"cloud_upload",size:"48px"}),$[1]||($[1]=m("div",{class:"text-h6 text-grey-7 q-mt-sm"},"Загрузить изображение",-1)),$[2]||($[2]=m("div",{class:"text-caption text-grey-6"}," Перетащите файл сюда или нажмите для выбора ",-1)),$[3]||($[3]=m("div",{class:"text-caption text-grey-5 q-mt-sm"}," Поддерживаемые форматы: JPG, PNG, GIF, WebP ",-1)),m("div",_a," Максимальный размер: "+C(ee((y.maxSizeKB??5e3)*1024)),1)])),x.value?(g(),w("div",wa,[a(ke,{thickness:.2,value:d.value,class:"q-ma-md",color:"primary",size:"50px","track-color":"grey-3"},null,8,["value"]),m("div",ka," Загрузка... "+C(d.value)+"% ",1)])):z("",!0)],34),V.value?(g(),w("div",xa,[a(j,{class:"q-mr-xs",name:"error"}),F(" "+C(V.value),1)])):z("",!0)]))}}),Sa={class:"text-h6"},Ca={class:"row"},Ba={key:3,class:"q-mb-md"},Pa={class:"text-subtitle2 q-mb-sm"},za={key:0,class:"text-negative"},Va={key:6,class:"q-mb-md"},qa={class:"text-subtitle2 q-mb-sm"},Ia={key:0,class:"text-negative"},Ua={key:7,class:"q-mb-md"},Da={class:"text-subtitle2 q-mb-sm"},Fa={key:0,class:"text-negative"},Ta=te({name:"AdminFormDialog",__name:"AdminFormDialog",props:{modelValue:{type:Boolean},config:{},item:{},loading:{type:Boolean}},emits:["update:modelValue","save","cancel"],setup(B,{emit:s}){const t=B,u=s,v=k(),l=k({}),x=Q(()=>!!t.item?.id);function d(c){const p=c.base64ImageOptions??{},e={maxSizeKB:p.maxSizeKB??2e3,quality:p.quality??.8,showPreview:p.showPreview??!0,allowCopy:p.allowCopy??!0,placeholder:c.placeholder??`Загрузите ${c.label.toLowerCase()}`};return p.allowedTypes&&(e.allowedTypes=p.allowedTypes),p.maxWidth&&(e.maxWidth=p.maxWidth),p.maxHeight&&(e.maxHeight=p.maxHeight),e}G(()=>t.item,c=>{c?l.value={...c}:V()},{immediate:!0}),G(()=>t.modelValue,c=>{c||V()});function V(){l.value={},t.config?.fields&&t.config.fields.forEach(c=>{switch(c.type){case"boolean":l.value[c.name]=!1;break;case"number":l.value[c.name]=0;break;case"editor":l.value[c.name]="";break;default:l.value[c.name]=""}})}function P(c){const p=[];return c.required&&p.push(e=>c.type==="boolean"?!0:e!=null&&String(e).trim()!==""||"Поле обязательно для заполнения"),c.type==="email"&&p.push(e=>e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e))||"Введите корректный email":!0),c.type==="url"&&p.push(e=>{if(!e)return!0;try{return new URL(String(e)),!0}catch{return"Введите корректный URL"}}),c.rules&&p.push(...c.rules),p}function I(c){return c==="email"?"email":c==="url"?"url":"text"}async function o(){if(!v.value||!await v.value.validate())return;const p={...l.value};x.value||(delete p.id,delete p.createdAt,delete p.updatedAt),u("save",p)}return(c,p)=>(g(),U(ce,{"model-value":c.modelValue,"onUpdate:modelValue":p[1]||(p[1]=e=>c.$emit("update:modelValue",e))},{default:i(()=>[a(ie,{style:{"min-width":"500px","max-width":"800px"}},{default:i(()=>[a(ae,null,{default:i(()=>[m("div",Sa,C(x.value?"Редактировать запись":"Создать запись"),1)]),_:1}),a(ae,{class:"q-pt-none"},{default:i(()=>[a(Ve,{ref_key:"formRef",ref:v,onSubmit:o},{default:i(()=>[m("div",Ca,[(g(!0),w(Ie,null,qe(c.config?.fields||[],e=>(g(),w("div",{key:e.name,class:"col-12"},[["text","email","url"].includes(e.type)?(g(),U(oe,{key:0,label:e.label,"model-value":String(l.value[e.name]||""),placeholder:e.placeholder,required:e.required,rules:P(e),type:I(e.type),filled:"","onUpdate:modelValue":n=>l.value[e.name]=n},null,8,["label","model-value","placeholder","required","rules","type","onUpdate:modelValue"])):e.type==="number"?(g(),U(oe,{key:1,label:e.label,"model-value":Number(l.value[e.name]||0),placeholder:e.placeholder,required:e.required,rules:P(e),type:"number",filled:"","onUpdate:modelValue":n=>l.value[e.name]=Number(n)},null,8,["label","model-value","placeholder","required","rules","onUpdate:modelValue"])):e.type==="textarea"?(g(),U(oe,{key:2,label:e.label,"model-value":String(l.value[e.name]||""),placeholder:e.placeholder,required:e.required,rules:P(e),rows:"4",type:"textarea",filled:"","onUpdate:modelValue":n=>l.value[e.name]=n},null,8,["label","model-value","placeholder","required","rules","onUpdate:modelValue"])):e.type==="editor"?(g(),w("div",Ba,[m("div",Pa,[F(C(e.label)+" ",1),e.required?(g(),w("span",za," * ")):z("",!0)]),a(Ue,{"model-value":String(l.value[e.name]||""),placeholder:e.placeholder,toolbar:[["bold","italic","underline","strike"],["quote","unordered","ordered"],["left","center","right","justify"],["undo","redo"],["removeFormat","hr"]],"min-height":"200px","onUpdate:modelValue":n=>l.value[e.name]=n},null,8,["model-value","placeholder","onUpdate:modelValue"])])):e.type==="date"?(g(),U(oe,{key:4,label:e.label,"model-value":String(l.value[e.name]||""),required:e.required,rules:P(e),type:"date",filled:"","onUpdate:modelValue":n=>l.value[e.name]=n},null,8,["label","model-value","required","rules","onUpdate:modelValue"])):e.type==="boolean"?(g(),U(De,{key:5,label:e.label,"model-value":!!l.value[e.name],"onUpdate:modelValue":n=>l.value[e.name]=n},null,8,["label","model-value","onUpdate:modelValue"])):e.type==="image"?(g(),w("div",Va,[m("div",qa,[F(C(e.label)+" ",1),e.required?(g(),w("span",Ia," * ")):z("",!0)]),a($a,{"model-value":l.value[e.name]?String(l.value[e.name]):null,"onUpdate:modelValue":n=>l.value[e.name]=n},null,8,["model-value","onUpdate:modelValue"])])):e.type==="base64-image"?(g(),w("div",Ua,[m("div",Da,[F(C(e.label)+" ",1),e.required?(g(),w("span",Fa," * ")):z("",!0)]),a(ca,Fe({"model-value":l.value[e.name]?String(l.value[e.name]):null},{ref_for:!0},d(e),{"onUpdate:modelValue":n=>l.value[e.name]=n}),null,16,["model-value","onUpdate:modelValue"])])):z("",!0)]))),128))])]),_:1},512)]),_:1}),a(ye,{align:"right",class:"text-primary"},{default:i(()=>[a(q,{color:"grey-6",label:"Отмена",outline:"",onClick:p[0]||(p[0]=e=>c.$emit("cancel"))}),a(q,{loading:c.loading,color:"positive",label:"Сохранить",outline:"",onClick:o},null,8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),ja={class:"base64-image-table-cell"},Qa={key:0,class:"base64-image-table-cell__overlay"},Ea={class:"base64-image-table-cell__error"},pe=te({name:"Base64ImageTableCell",__name:"Base64ImageTableCell",props:{base64:{default:null},alt:{default:"Image"},size:{default:40},clickable:{type:Boolean,default:!1}},emits:["click"],setup(B,{emit:s}){const t=B,u=s,{isValidBase64Image:v}=$e(),l=Q(()=>!!(t.base64&&v(t.base64)));function x(){t.clickable&&l.value&&u("click")}return(d,V)=>(g(),w("div",ja,[l.value?(g(),U(re,{key:0,alt:d.alt,src:d.base64||void 0,style:he({width:`${d.size}px`,height:`${d.size}px`}),class:"base64-image-table-cell__thumbnail",fit:"cover",loading:"lazy",onClick:x},{error:i(()=>[m("div",Ea,[a(j,{color:"grey-5",name:"broken_image",size:"24px"})])]),default:i(()=>[d.clickable?(g(),w("div",Qa,[a(j,{color:"white",name:"zoom_in",size:"20px"})])):z("",!0)]),_:1},8,["alt","src","style"])):(g(),w("div",{key:1,style:he({width:`${d.size}px`,height:`${d.size}px`}),class:"base64-image-table-cell__placeholder"},[a(j,{color:"grey-5",name:"image",size:"24px"})],4))]))}}),Ka={class:"image-table-cell"},Ra={class:"image-table-cell__overlay"},Na={class:"image-table-cell__error"},La={key:1,class:"image-table-cell__placeholder"},Aa={class:"image-table-cell__error-full"},Wa=te({name:"ImageTableCell",__name:"ImageTableCell",props:{imageUrl:{default:null},alt:{default:"Image"},size:{default:40}},setup(B){const s=B,t=k(!1);function u(){s.imageUrl&&(t.value=!0)}function v(){if(!s.imageUrl)return;const l=document.createElement("a");l.href=s.imageUrl,l.download=s.alt||"image",l.target="_blank",document.body.appendChild(l),l.click(),document.body.removeChild(l)}return(l,x)=>(g(),w("div",Ka,[l.imageUrl?(g(),U(re,{key:0,alt:l.alt,src:l.imageUrl,class:"image-table-cell__thumbnail",fit:"cover",loading:"lazy",onClick:u},{error:i(()=>[m("div",Na,[a(j,{color:"grey-5",name:"broken_image",size:"24px"})])]),default:i(()=>[m("div",Ra,[a(j,{color:"white",name:"zoom_in",size:"20px"})])]),_:1},8,["alt","src"])):(g(),w("div",La,[a(j,{color:"grey-5",name:"image",size:"24px"})])),a(ce,{modelValue:t.value,"onUpdate:modelValue":x[1]||(x[1]=d=>t.value=d)},{default:i(()=>[a(ie,{class:"image-table-cell__dialog"},{default:i(()=>[a(ae,{class:"q-pa-none"},{default:i(()=>[a(re,{alt:l.alt,src:l.imageUrl||void 0,fit:"contain",style:{"max-height":"80vh","max-width":"80vw"}},{error:i(()=>[m("div",Aa,[a(j,{color:"grey-5",name:"broken_image",size:"48px"}),x[2]||(x[2]=m("div",{class:"text-grey-7 q-mt-sm"}," Ошибка загрузки изображения ",-1))])]),_:1},8,["alt","src"])]),_:1}),a(ye,{align:"right"},{default:i(()=>[a(q,{label:"Закрыть",flat:"",onClick:x[0]||(x[0]=d=>t.value=!1)}),l.imageUrl?(g(),U(q,{key:0,color:"primary",icon:"download",label:"Скачать",flat:"",onClick:v})):z("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}}),Oa={key:0,class:"text-caption text-grey-6 q-ml-sm"},Ma={class:"text-body2"},Ha={class:"q-mt-xs q-mb-none"},Ga={key:0},Ja={key:1},Xa={key:2},Ya=te({__name:"TableSettingsIndicator",props:{settings:{}},setup(B){const s=B,t=Q(()=>(s.settings.sortBy??!1)||(s.settings.filter??!1)||s.settings.rowsPerPage!==10||s.settings.page>1);return(u,v)=>t.value?(g(),w("div",Oa,[a(j,{class:"q-mr-xs",name:"settings",size:"12px"}),v[1]||(v[1]=F(" Настройки сохранены ")),a(H,null,{default:i(()=>[m("div",Ma,[v[0]||(v[0]=m("div",null,"Сохраненные настройки:",-1)),m("ul",Ha,[u.settings.sortBy?(g(),w("li",Ga," Сортировка: "+C(u.settings.sortBy)+" "+C(u.settings.descending?"(убыв.)":"(возр.)"),1)):z("",!0),u.settings.filter?(g(),w("li",Ja,'Фильтр: "'+C(u.settings.filter)+'"',1)):z("",!0),m("li",null,"Записей на странице: "+C(u.settings.rowsPerPage),1),u.settings.page>1?(g(),w("li",Xa," Текущая страница: "+C(u.settings.page),1)):z("",!0)])])]),_:1})])):z("",!0)}}),fe={page:1,rowsPerPage:10,filter:""};function Za(B){const s=Q(()=>`table-settings-${String(N(B))}`);function t(){try{const e=ne.getItem(s.value);if(e&&typeof e=="object"&&e!==null){const n=e;return{...fe,...typeof n.page=="number"&&n.page>0&&{page:n.page},...typeof n.rowsPerPage=="number"&&n.rowsPerPage>0&&{rowsPerPage:n.rowsPerPage},...typeof n.sortBy=="string"&&n.sortBy.length>0&&{sortBy:n.sortBy},...typeof n.descending=="boolean"&&{descending:n.descending},...typeof n.filter=="string"&&{filter:n.filter},...Array.isArray(n.visibleColumns)&&{visibleColumns:n.visibleColumns}}}}catch(e){console.warn(`Failed to load table settings for ${String(N(B))}:`,e)}return{...fe}}function u(e){try{ne.set(s.value,e)}catch(n){console.warn(`Failed to save table settings for ${String(N(B))}:`,n)}}function v(){try{ne.remove(s.value)}catch(e){console.warn(`Failed to clear table settings for ${String(N(B))}:`,e)}}function l(){return ne.has(s.value)}function x(){try{const e=ne.getItem(s.value);if(e)return JSON.stringify(e).length}catch(e){console.warn(`Failed to calculate storage size for ${String(N(B))}:`,e)}return 0}const d=k(t());G(()=>N(B),()=>{const e=t();Object.assign(d.value,e)}),G(d,e=>{u(e)},{deep:!0});function V(e){d.value.page=e.page,d.value.rowsPerPage=e.rowsPerPage,e.sortBy!==void 0&&(d.value.sortBy=e.sortBy),e.descending!==void 0&&(d.value.descending=e.descending)}function P(e){d.value.filter=e,d.value.page=1}function I(e){d.value.visibleColumns=e}function o(){d.value={...fe}}const c=Q(()=>({page:d.value.page,rowsPerPage:d.value.rowsPerPage,rowsNumber:0,sortBy:d.value.sortBy,descending:d.value.descending}));function p(){const e=t();Object.assign(d.value,e)}return{settings:d,paginationSettings:c,updatePagination:V,updateFilter:P,updateVisibleColumns:I,resetSettings:o,clearSettings:v,hasSettings:l,getStorageSize:x,loadSettings:t,saveSettings:u,reloadSettings:p}}const et={class:"row items-center justify-between q-mb-md"},at={class:"text-h4"},tt={class:"row q-gutter-md items-center"},lt={class:"col-12 col-md-6"},ot={class:"col-auto"},st={class:"col-auto"},nt={key:0,class:"col-auto"},it={class:"col-auto text-grey-6"},rt={class:"full-width row flex-center text-grey-7 q-gutter-sm"},ut={class:"q-ml-sm"},dt=["src"],ft=te({name:"AdminCollectionPage",__name:"AdminCollectionPage",setup(B){const s=Te(),t=je(),u=Q(()=>t.params.collection),v=Q(()=>Ge(u.value));function l(h){return v.value?.fields.find(r=>r.name===h)?.type}const{settings:x,paginationSettings:d,updatePagination:V,updateFilter:P,resetSettings:I}=Za(u),o=k({items:[],loading:!1,pagination:{page:d.value.page,rowsPerPage:d.value.rowsPerPage,rowsNumber:0,...d.value.sortBy&&{sortBy:d.value.sortBy},...d.value.descending!==void 0&&{descending:d.value.descending}},filter:x.value.filter,selected:[]}),c=k([]),p=k([]),e=k(!1),n=k(!1),J=k(!1),le=k(""),Y=k(!1),L=k(null),O=k(null),Z=Q(()=>o.value.filter.trim()?`Найдено: ${p.value.length} из ${c.value.length}`:`Всего записей: ${c.value.length}`),se=Q(()=>o.value.selected.length>1?`Вы действительно хотите удалить ${o.value.selected.length} записей?`:"Вы действительно хотите удалить эту запись?");Qe(()=>{ee(),S()}),G(()=>u.value,(h,r)=>{h!==r&&h&&(ee(),r&&v.value?.label&&s.notify({type:"info",message:`Переключено на: ${v.value.label}`,position:"top",timeout:1e3}),S())}),G(()=>o.value.filter,h=>{P(h)}),G(()=>o.value.pagination,h=>{V(h)},{deep:!0});function ee(){o.value={items:[],loading:!0,pagination:{page:d.value.page,rowsPerPage:d.value.rowsPerPage,rowsNumber:0,...d.value.sortBy&&{sortBy:d.value.sortBy},...d.value.descending!==void 0&&{descending:d.value.descending}},filter:x.value.filter,selected:[]},c.value=[],p.value=[],e.value=!1,n.value=!1,L.value=null,O.value=null}function M(h){if(!h.trim())p.value=[...c.value];else{const r=h.toLowerCase(),f=v.value?.fields?.map(D=>D.name)??[];p.value=c.value.filter(D=>f.some(W=>{const T=D[W];return T==null?!1:String(T).toLowerCase().includes(r)}))}y(),o.value.pagination.rowsNumber=p.value.length,o.value.pagination.page=1}function y(){if(!o.value.pagination.sortBy){o.value.items=p.value;return}const{sortBy:h}=o.value.pagination,r=o.value.pagination.descending??!1,f=[...p.value].sort((D,W)=>{const T=D[h],K=W[h];if(T==null)return K==null?0:r?1:-1;if(K==null)return r?-1:1;if(typeof T=="string"&&typeof K=="string"){const X=T.localeCompare(K,"ru",{numeric:!0,sensitivity:"base"});return r?-X:X}if(typeof T=="number"&&typeof K=="number"){const X=T-K;return r?-X:X}if(T instanceof Date&&K instanceof Date){const X=T.getTime()-K.getTime();return r?-X:X}const Be=String(T),Pe=String(K),be=Be.localeCompare(Pe,"ru",{numeric:!0,sensitivity:"base"});return r?-be:be});o.value.items=f}function $(){o.value.filter="",M("")}async function S(){if(!v.value){s.notify({type:"negative",message:"Конфигурация коллекции не найдена",position:"top"});return}o.value.loading=!0;try{const h=await de.getCollection(u.value);h.error?s.notify({type:"negative",message:h.error,position:"top"}):(c.value=h.items,M(o.value.filter))}finally{o.value.loading=!1}}function E(h){const{page:r,rowsPerPage:f,sortBy:D,descending:W}=h.pagination;o.value.pagination.page=r,o.value.pagination.rowsPerPage=f,(o.value.pagination.sortBy!==D||o.value.pagination.descending!==W)&&(D!==void 0&&(o.value.pagination.sortBy=D),W!==void 0&&(o.value.pagination.descending=W),y()),V(h.pagination)}function me(h){L.value={...h},e.value=!0}function b(h){O.value=h,o.value.selected=[h],n.value=!0}function _(){n.value=!0}function A(){I(),o.value.pagination={page:1,rowsPerPage:10,rowsNumber:o.value.pagination.rowsNumber},o.value.filter="",M(""),s.notify({type:"positive",message:"Настройки таблицы сброшены",position:"top"})}async function Se(h){Y.value=!0;try{if(L.value?.id){const r=await de.updateDocument(u.value,L.value.id,h);r.error?s.notify({type:"negative",message:r.error,position:"top"}):(s.notify({type:"positive",message:"Запись успешно обновлена",position:"top"}),await S(),ge())}else{const r=await de.createDocument(u.value,h);r.error?s.notify({type:"negative",message:r.error,position:"top"}):(s.notify({type:"positive",message:"Запись успешно создана",position:"top"}),await S(),ge())}}finally{Y.value=!1}}function ge(){e.value=!1,L.value=null}async function Ce(){const h=o.value.selected.length>0?o.value.selected:O.value?[O.value]:[];if(h.length!==0)try{const r=h.map(W=>de.deleteDocument(u.value,W.id));(await Promise.all(r)).some(W=>W.error)?s.notify({type:"negative",message:"Произошла ошибка при удалении некоторых записей",position:"top"}):s.notify({type:"positive",message:`Успешно удалено ${h.length} записей`,position:"top"}),await S()}finally{n.value=!1,o.value.selected=[],O.value=null}}function ve(h){le.value=h,J.value=!0}return(h,r)=>(g(),U(Ae,{class:"q-pa-md"},{default:i(()=>[m("div",et,[m("div",null,[m("div",at,C(v.value?.label||u.value),1),r[9]||(r[9]=m("div",{class:"text-subtitle1 text-grey-7"}," Управление записями в коллекции ",-1))]),a(q,{color:"primary",icon:"add",label:"Создать запись",onClick:r[0]||(r[0]=f=>e.value=!0)})]),a(ie,{class:"q-mb-md",bordered:"",flat:""},{default:i(()=>[a(ae,null,{default:i(()=>[m("div",tt,[m("div",lt,[a(oe,{modelValue:o.value.filter,"onUpdate:modelValue":[r[1]||(r[1]=f=>o.value.filter=f),r[2]||(r[2]=f=>M(String(f||"")))],debounce:"300",label:"Поиск",placeholder:"Поиск по всем полям...",clearable:"",filled:"",onClear:$},{append:i(()=>[a(j,{name:"search"})]),_:1},8,["modelValue"])]),m("div",ot,[a(q,{color:"secondary",icon:"refresh",padding:"12px",size:"md",onClick:S})]),m("div",st,[a(q,{color:"grey",icon:"settings_backup_restore",padding:"12px",size:"md",onClick:A},{default:i(()=>[a(H,null,{default:i(()=>r[10]||(r[10]=[F("Сбросить настройки таблицы")])),_:1,__:[10]})]),_:1})]),o.value.selected.length>0?(g(),w("div",nt,[a(q,{label:`Удалить (${o.value.selected.length})`,color:"negative",icon:"delete",padding:"12px",size:"md",onClick:_},null,8,["label"])])):z("",!0),m("div",it,[F(C(Z.value)+" ",1),a(Ya,{settings:N(x)},null,8,["settings"])])])]),_:1})]),_:1}),a(Ee,{pagination:o.value.pagination,"onUpdate:pagination":r[3]||(r[3]=f=>o.value.pagination=f),selected:o.value.selected,"onUpdate:selected":r[4]||(r[4]=f=>o.value.selected=f),columns:v.value?.columns||[],loading:o.value.loading,rows:o.value.items,"row-key":"id",selection:"multiple","server-pagination":"",onRequest:E},{"body-cell-actions":i(f=>[a(ue,{props:f},{default:i(()=>[a(q,{color:"primary",icon:"edit",dense:"",flat:"",round:"",onClick:D=>me(f.row)},{default:i(()=>[a(H,null,{default:i(()=>r[11]||(r[11]=[F("Редактировать")])),_:1,__:[11]})]),_:2},1032,["onClick"]),a(q,{color:"negative",icon:"delete",dense:"",flat:"",round:"",onClick:D=>b(f.row)},{default:i(()=>[a(H,null,{default:i(()=>r[12]||(r[12]=[F("Удалить")])),_:1,__:[12]})]),_:2},1032,["onClick"])]),_:2},1032,["props"])]),"body-cell-img":i(f=>[a(ue,{props:f},{default:i(()=>[l("img")==="base64-image"?(g(),U(pe,{key:0,alt:`Изображение ${f.row.id}`,"base64-src":f.value,"show-as":"image",onClick:D=>ve(f.value)},null,8,["alt","base64-src","onClick"])):(g(),U(Wa,{key:1,alt:`Изображение ${f.row.id}`,"image-url":f.value},null,8,["alt","image-url"]))]),_:2},1032,["props"])]),"body-cell-image":i(f=>[a(ue,{props:f},{default:i(()=>[a(pe,{alt:`Изображение ${f.row.id}`,base64:f.value,clickable:!0,size:60,onClick:D=>ve(f.value)},null,8,["alt","base64","onClick"])]),_:2},1032,["props"])]),"body-cell-thumbnail":i(f=>[a(ue,{props:f},{default:i(()=>[a(pe,{alt:`Миниатюра ${f.row.id}`,base64:f.value,clickable:!0,size:40,onClick:D=>ve(f.value)},null,8,["alt","base64","onClick"])]),_:2},1032,["props"])]),"no-data":i(()=>[m("div",rt,[a(j,{name:"inbox",size:"2em"}),r[13]||(r[13]=m("span",null,"Нет данных для отображения",-1))])]),_:1},8,["pagination","selected","columns","loading","rows"]),a(Ta,{modelValue:e.value,"onUpdate:modelValue":r[5]||(r[5]=f=>e.value=f),config:v.value,item:L.value,loading:Y.value,onCancel:ge,onSave:Se},null,8,["modelValue","config","item","loading"]),a(ce,{modelValue:n.value,"onUpdate:modelValue":r[7]||(r[7]=f=>n.value=f)},{default:i(()=>[a(ie,null,{default:i(()=>[a(ae,{class:"row items-center"},{default:i(()=>[a(Ke,{color:"negative",icon:"warning","text-color":"white"}),m("span",ut,C(se.value),1)]),_:1}),a(ye,{align:"right"},{default:i(()=>[a(q,{label:"Отмена",flat:"",onClick:r[6]||(r[6]=f=>n.value=!1)}),a(q,{color:"negative",label:"Удалить",flat:"",onClick:Ce})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(ce,{modelValue:J.value,"onUpdate:modelValue":r[8]||(r[8]=f=>J.value=f),maximized:""},{default:i(()=>[a(ie,{class:"bg-dark text-white"},{default:i(()=>[a(ae,{class:"row items-center q-pb-none"},{default:i(()=>[r[14]||(r[14]=m("div",{class:"text-h6"},"Просмотр изображения",-1)),a(Ne),Re(a(q,{icon:"close",dense:"",flat:"",round:""},null,512),[[Le]])]),_:1,__:[14]}),a(ae,{class:"q-pt-none flex flex-center"},{default:i(()=>[m("img",{src:le.value,alt:"Просмотр изображения",style:{"max-width":"100%","max-height":"90vh","object-fit":"contain"}},null,8,dt)]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}});export{ft as default};
